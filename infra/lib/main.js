"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Main = exports.MainStack = void 0;
const cdk = require("aws-cdk-lib");
const helpers = require("../components/helperScripts");
const s3_1 = require("../components/s3");
const lambda_1 = require("../components/lambda");
const ddb_1 = require("../components/ddb");
const cognito_1 = require("../components/cognito");
const apigateway_1 = require("../components/apigateway");
const ddb = require("aws-cdk-lib/aws-dynamodb");
const aws_dynamodb_1 = require("aws-cdk-lib/aws-dynamodb");
const webSiteDistribution_1 = require("../components/webSiteDistribution");
class MainStack extends cdk.Stack {
    constructor(app, id, props) {
        super(app, id, props);
        const contextValues = {};
        this.mainStack = new Main(this, contextValues);
    }
}
exports.MainStack = MainStack;
class Main {
    constructor(scope, contextValues) {
        //Make S3 Bucket
        const storageBucket = new s3_1.S3Bucket(scope, "StorageBucket", cdk.RemovalPolicy.DESTROY);
        //DynamoDB Database
        const storageDatabase = new ddb_1.DDBTable(scope, "StorageDatabase", "bucket", "key", aws_dynamodb_1.BillingMode.PAY_PER_REQUEST, cdk.RemovalPolicy.DESTROY);
        const leaderboardDatabase = new ddb_1.DDBTable(scope, "LeaderboardDatabase", "playerId", undefined, aws_dynamodb_1.BillingMode.PAY_PER_REQUEST, cdk.RemovalPolicy.DESTROY);
        // Add Global Secondary Index to Leaderboard Database for Ranking queries
        leaderboardDatabase.addGlobalSecondaryIndex({
            indexName: 'rankingIndex',
            partitionKey: {
                name: 'status',
                type: ddb.AttributeType.NUMBER
            },
            sortKey: {
                name: 'score',
                type: ddb.AttributeType.NUMBER
            }
        });
        //Lambda layer
        const storageEnvs = {
            BUCKET_NAME: storageBucket.bucketName,
            TABLE_NAME: storageDatabase.tableName
        };
        const highScoreEnvs = {
            TABLE_NAME: leaderboardDatabase.tableName
        };
        //Make Nested Lambda Stack(s)
        const getAssetLambda = new lambda_1.LambdaStack(scope, "getAssetLambda", cdk.aws_lambda.Runtime.NODEJS_18_X, '../lambdaScripts/getAsset', 'handler', cdk.Duration.minutes(5), 512, 512, storageEnvs);
        const getHighScoreLambda = new lambda_1.LambdaStack(scope, "getPlayerInfoLambda", cdk.aws_lambda.Runtime.NODEJS_18_X, '../lambdaScripts/getPlayerInfo', 'handler', cdk.Duration.minutes(5), 512, 512, highScoreEnvs);
        const putHighScoreLambda = new lambda_1.LambdaStack(scope, "putPlayerRecordLambda", cdk.aws_lambda.Runtime.NODEJS_18_X, '../lambdaScripts/putPlayerRecord', 'handler', cdk.Duration.minutes(5), 512, 512, highScoreEnvs);
        //const preSignupLambda = new LambdaStack(scope, "preSignupLambda", cdk.aws_lambda.Runtime.NODEJS_18_X, '../lambdaScripts/preSignup', 'handler', cdk.Duration.minutes(5), 512, 512);
        //const preSignupFunction = preSignupLambda.getLambdaFunction();
        //Grant Lambda functions read/write access to S3 bucket
        storageBucket.grantReadWrite(getAssetLambda.lambdaFunction);
        //Grant Lambda functions read/write access to DDB table
        storageDatabase.grantReadWriteData(getAssetLambda.lambdaFunction);
        leaderboardDatabase.grantReadData(getHighScoreLambda.lambdaFunction);
        leaderboardDatabase.grantReadWriteData(putHighScoreLambda.lambdaFunction);
        // Define a Lambda function
        //Build Cognito Stack
        const cognitoStack = new cognito_1.CognitoStack(scope, "auth", true, true);
        //const adminEmail=cognitoStack.AddUser(scope, "AdminUser", "AdminEmail", cognitoStack.userPool.userPoolId)
        //Build API Gateway
        const apiGateway = new apigateway_1.restGatewayNestedStack(scope, "gateway", "Main Stack Gateway", "dev").gateway;
        // apiGateway.AttachWebACL(scope, "apigACL");
        const apiAuthorizer = apiGateway.AddCognitoAuthorizer(scope, "API_Authorizer", [cognitoStack.userPool]);
        apiGateway.AddMethodIntegration(getAssetLambda.MethodIntegration(), "assets", "GET", apiAuthorizer);
        apiGateway.AddMethodIntegration(putHighScoreLambda.MethodIntegration(), "leaderboard", "POST", apiAuthorizer);
        apiGateway.AddMethodIntegration(getHighScoreLambda.MethodIntegration(), "leaderboard/{playerId}", "GET", apiAuthorizer);
        //Upload Website
        const website = new webSiteDistribution_1.WebSiteDeployment(scope, "webDeployment", '../../web/dist', 'index.html', apiGateway, storageBucket);
        // const apiURL = website.AddDistributionBehavior('/apis/*', new cdk.aws_cloudfront_origins.RestApiOrigin(apiGateway, {}));
        // apiGateway.apiGatewayURL = website.cloudfrontDistribution.distributionDomainName + "/apis"
        const configJson = {
            //   ...storageBucket.ExportConfig(),
            //   ...apiGateway.ExportConfig(),
            ...cognitoStack.ExportConfig()
        };
        // const configGen=new ConfigGenerator(scope, 'ConfigGen', configJson);
        // configGen.node.addDependency([website.cloudfrontDistribution]);
        helpers.OutputVariable(scope, "Params", configJson, "Configuration");
        helpers.OutputVariable(scope, "CLI Set User Password Command", `aws cognito-idp admin-set-user-password --user-pool-id ${cognitoStack.userPool.userPoolId} --permanent --username {insert email} --password {insert password}`, "Configure admin password");
    }
}
exports.Main = Main;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIm1haW4udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsbUNBQW1DO0FBQ25DLHVEQUF1RDtBQUN2RCx5Q0FBNEM7QUFDNUMsaURBQW9EO0FBQ3BELDJDQUE2QztBQUM3QyxtREFBcUQ7QUFDckQseURBQWtFO0FBQ2xFLGdEQUFnRDtBQUVoRCwyREFBdUQ7QUFJdkQsMkVBQXNFO0FBRXRFLE1BQWEsU0FBVSxTQUFRLEdBQUcsQ0FBQyxLQUFLO0lBRXRDLFlBQVksR0FBWSxFQUFFLEVBQVUsRUFBRSxLQUFzQjtRQUMxRCxLQUFLLENBQUMsR0FBRyxFQUFFLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUN0QixNQUFNLGFBQWEsR0FBRyxFQUNyQixDQUFDO1FBQ0YsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLElBQUksQ0FBQyxJQUFJLEVBQUUsYUFBYSxDQUFDLENBQUM7SUFDakQsQ0FBQztDQUNGO0FBUkQsOEJBUUM7QUFFRCxNQUFhLElBQUk7SUFDZixZQUFZLEtBQWdCLEVBQUUsYUFBa0I7UUFDOUMsZ0JBQWdCO1FBQ2hCLE1BQU0sYUFBYSxHQUFHLElBQUksYUFBUSxDQUFDLEtBQUssRUFBRSxlQUFlLEVBQUUsR0FBRyxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUN0RixtQkFBbUI7UUFDbkIsTUFBTSxlQUFlLEdBQUcsSUFBSSxjQUFRLENBQUMsS0FBSyxFQUFFLGlCQUFpQixFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsMEJBQVcsQ0FBQyxlQUFlLEVBQUUsR0FBRyxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUN4SSxNQUFNLG1CQUFtQixHQUFHLElBQUksY0FBUSxDQUFDLEtBQUssRUFBRSxxQkFBcUIsRUFBRSxVQUFVLEVBQUUsU0FBUyxFQUFFLDBCQUFXLENBQUMsZUFBZSxFQUFFLEdBQUcsQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLENBQUM7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QUFNLEVBQUUsYUFBYSxDQUFDLENBQUM7UUFDOUcsVUFBVSxDQUFDLG9CQUFvQixDQUFDLGtCQUFrQixDQUFDLGlCQUFpQixFQUFFLEVBQUUsd0JBQXdCLEVBQUUsS0FBSyxFQUFFLGFBQWEsQ0FBQyxDQUFDO1FBR3hILGdCQUFnQjtRQUNoQixNQUFNLE9BQU8sR0FBRyxJQUFJLHVDQUFpQixDQUFDLEtBQUssRUFBRSxlQUFlLEVBQUUsZ0JBQWdCLEVBQUUsWUFBWSxFQUFFLFVBQVUsRUFBRSxhQUFhLENBQUMsQ0FBQztRQUN6SCwySEFBMkg7UUFDM0gsNkZBQTZGO1FBQzVGLE1BQU0sVUFBVSxHQUFHO1lBQ3BCLHFDQUFxQztZQUNyQyxrQ0FBa0M7WUFDN0IsR0FBRyxZQUFZLENBQUMsWUFBWSxFQUFFO1NBQ2xDLENBQUE7UUFFRCx1RUFBdUU7UUFDdkUsa0VBQWtFO1FBQ2xFLE9BQU8sQ0FBQyxjQUFjLENBQUMsS0FBSyxFQUFFLFFBQVEsRUFBRSxVQUFVLEVBQUUsZUFBZSxDQUFDLENBQUE7UUFDcEUsT0FBTyxDQUFDLGNBQWMsQ0FBQyxLQUFLLEVBQUUsK0JBQStCLEVBQUUsMERBQTBELFlBQVksQ0FBQyxRQUFRLENBQUMsVUFBVSxxRUFBcUUsRUFBRSwwQkFBMEIsQ0FBQyxDQUFBO0lBQzdQLENBQUM7Q0FDRjtBQTdFRCxvQkE2RUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBjZGsgZnJvbSAnYXdzLWNkay1saWInO1xuaW1wb3J0ICogYXMgaGVscGVycyBmcm9tICcuLi9jb21wb25lbnRzL2hlbHBlclNjcmlwdHMnO1xuaW1wb3J0IHsgUzNCdWNrZXQgfSBmcm9tICcuLi9jb21wb25lbnRzL3MzJztcbmltcG9ydCB7ICBMYW1iZGFTdGFjayB9IGZyb20gJy4uL2NvbXBvbmVudHMvbGFtYmRhJztcbmltcG9ydCB7IEREQlRhYmxlIH0gZnJvbSAnLi4vY29tcG9uZW50cy9kZGInO1xuaW1wb3J0IHsgQ29nbml0b1N0YWNrIH0gZnJvbSAnLi4vY29tcG9uZW50cy9jb2duaXRvJztcbmltcG9ydCB7IHJlc3RHYXRld2F5TmVzdGVkU3RhY2sgfSBmcm9tICcuLi9jb21wb25lbnRzL2FwaWdhdGV3YXknO1xuaW1wb3J0ICogYXMgZGRiIGZyb20gJ2F3cy1jZGstbGliL2F3cy1keW5hbW9kYic7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tICdjb25zdHJ1Y3RzJztcbmltcG9ydCB7IEJpbGxpbmdNb2RlIH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWR5bmFtb2RiJztcbmltcG9ydCAqIGFzIGNsb3VkZnJvbnRfb3JpZ2lucyBmcm9tICdhd3MtY2RrLWxpYi9hd3MtY2xvdWRmcm9udC1vcmlnaW5zJztcbmltcG9ydCB7IENmbk91dHB1dCwgRHVyYXRpb24sIFJlbW92YWxQb2xpY3ksIFN0YWNrIH0gZnJvbSAnYXdzLWNkay1saWInO1xuaW1wb3J0ICogYXMgczNkZXBsb3kgZnJvbSAnYXdzLWNkay1saWIvYXdzLXMzLWRlcGxveW1lbnQnO1xuaW1wb3J0IHsgV2ViU2l0ZURlcGxveW1lbnQgfSBmcm9tICcuLi9jb21wb25lbnRzL3dlYlNpdGVEaXN0cmlidXRpb24nO1xuXG5leHBvcnQgY2xhc3MgTWFpblN0YWNrIGV4dGVuZHMgY2RrLlN0YWNrIHtcbiAgcHVibGljIG1haW5TdGFjazogTWFpblxuICBjb25zdHJ1Y3RvcihhcHA6IGNkay5BcHAsIGlkOiBzdHJpbmcsIHByb3BzPzogY2RrLlN0YWNrUHJvcHMpIHtcbiAgICBzdXBlcihhcHAsIGlkLCBwcm9wcyk7XG4gICAgY29uc3QgY29udGV4dFZhbHVlcyA9IHtcbiAgICB9O1xuICAgIHRoaXMubWFpblN0YWNrID0gbmV3IE1haW4odGhpcywgY29udGV4dFZhbHVlcyk7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIE1haW4ge1xuICBjb25zdHJ1Y3RvcihzY29wZTogY2RrLlN0YWNrLCBjb250ZXh0VmFsdWVzOiBhbnkpIHtcbiAgICAvL01ha2UgUzMgQnVja2V0XG4gICAgY29uc3Qgc3RvcmFnZUJ1Y2tldCA9IG5ldyBTM0J1Y2tldChzY29wZSwgXCJTdG9yYWdlQnVja2V0XCIsIGNkay5SZW1vdmFsUG9saWN5LkRFU1RST1kpO1xuICAgIC8vRHluYW1vREIgRGF0YWJhc2VcbiAgICBjb25zdCBzdG9yYWdlRGF0YWJhc2UgPSBuZXcgRERCVGFibGUoc2NvcGUsIFwiU3RvcmFnZURhdGFiYXNlXCIsIFwiYnVja2V0XCIsIFwia2V5XCIsIEJpbGxpbmdNb2RlLlBBWV9QRVJfUkVRVUVTVCwgY2RrLlJlbW92YWxQb2xpY3kuREVTVFJPWSk7XG4gICAgY29uc3QgbGVhZGVyYm9hcmREYXRhYmFzZSA9IG5ldyBEREJUYWJsZShzY29wZSwgXCJMZWFkZXJib2FyZERhdGFiYXNlXCIsIFwicGxheWVySWRcIiwgdW5kZWZpbmVkLCBCaWxsaW5nTW9kZS5QQVlfUEVSX1JFUVVFU1QsIGNkay5SZW1vdmFsUG9saWN5LkRFU1RST1kpO1xuICAgIFxuICAgIC8vIEFkZCBHbG9iYWwgU2Vjb25kYXJ5IEluZGV4IHRvIExlYWRlcmJvYXJkIERhdGFiYXNlIGZvciBSYW5raW5nIHF1ZXJpZXNcbiAgICBsZWFkZXJib2FyZERhdGFiYXNlLmFkZEdsb2JhbFNlY29uZGFyeUluZGV4KHtcbiAgICAgIGluZGV4TmFtZTogJ3JhbmtpbmdJbmRleCcsXG4gICAgICBwYXJ0aXRpb25LZXk6IHtcbiAgICAgICAgbmFtZTogJ3N0YXR1cycsXG4gICAgICAgIHR5cGU6IGRkYi5BdHRyaWJ1dGVUeXBlLk5VTUJFUlxuICAgICAgfSxcbiAgICAgIHNvcnRLZXk6IHtcbiAgICAgICAgbmFtZTogJ3Njb3JlJyxcbiAgICAgICAgdHlwZTogZGRiLkF0dHJpYnV0ZVR5cGUuTlVNQkVSXG4gICAgICB9XG4gICAgfSlcblxuICAgIC8vTGFtYmRhIGxheWVyXG4gICAgY29uc3Qgc3RvcmFnZUVudnMgPSB7XG4gICAgICBCVUNLRVRfTkFNRTogc3RvcmFnZUJ1Y2tldC5idWNrZXROYW1lLFxuICAgICAgVEFCTEVfTkFNRTogc3RvcmFnZURhdGFiYXNlLnRhYmxlTmFtZVxuICAgIH07XG5cbiAgICBjb25zdCBoaWdoU2NvcmVFbnZzID0ge1xuICAgICAgVEFCTEVfTkFNRTogbGVhZGVyYm9hcmREYXRhYmFzZS50YWJsZU5hbWVcbiAgICB9XG5cbiAgICAvL01ha2UgTmVzdGVkIExhbWJkYSBTdGFjayhzKVxuICAgIGNvbnN0IGdldEFzc2V0TGFtYmRhID0gbmV3IExhbWJkYVN0YWNrKHNjb3BlLCBcImdldEFzc2V0TGFtYmRhXCIsIGNkay5hd3NfbGFtYmRhLlJ1bnRpbWUuTk9ERUpTXzE4X1gsICcuLi9sYW1iZGFTY3JpcHRzL2dldEFzc2V0JywgJ2hhbmRsZXInLCBjZGsuRHVyYXRpb24ubWludXRlcyg1KSwgNTEyLCA1MTIsIHN0b3JhZ2VFbnZzKTtcbiAgICBjb25zdCBnZXRIaWdoU2NvcmVMYW1iZGEgPSBuZXcgTGFtYmRhU3RhY2soc2NvcGUsIFwiZ2V0UGxheWVySW5mb0xhbWJkYVwiLCBjZGsuYXdzX2xhbWJkYS5SdW50aW1lLk5PREVKU18xOF9YLCAnLi4vbGFtYmRhU2NyaXB0cy9nZXRQbGF5ZXJJbmZvJywgJ2hhbmRsZXInLCBjZGsuRHVyYXRpb24ubWludXRlcyg1KSwgNTEyLCA1MTIsIGhpZ2hTY29yZUVudnMpO1xuICAgIGNvbnN0IHB1dEhpZ2hTY29yZUxhbWJkYSA9IG5ldyBMYW1iZGFTdGFjayhzY29wZSwgXCJwdXRQbGF5ZXJSZWNvcmRMYW1iZGFcIiwgY2RrLmF3c19sYW1iZGEuUnVudGltZS5OT0RFSlNfMThfWCwgJy4uL2xhbWJkYVNjcmlwdHMvcHV0UGxheWVyUmVjb3JkJywgJ2hhbmRsZXInLCBjZGsuRHVyYXRpb24ubWludXRlcyg1KSwgNTEyLCA1MTIsIGhpZ2hTY29yZUVudnMpO1xuICAgIC8vY29uc3QgcHJlU2lnbnVwTGFtYmRhID0gbmV3IExhbWJkYVN0YWNrKHNjb3BlLCBcInByZVNpZ251cExhbWJkYVwiLCBjZGsuYXdzX2xhbWJkYS5SdW50aW1lLk5PREVKU18xOF9YLCAnLi4vbGFtYmRhU2NyaXB0cy9wcmVTaWdudXAnLCAnaGFuZGxlcicsIGNkay5EdXJhdGlvbi5taW51dGVzKDUpLCA1MTIsIDUxMik7XG4gICAgLy9jb25zdCBwcmVTaWdudXBGdW5jdGlvbiA9IHByZVNpZ251cExhbWJkYS5nZXRMYW1iZGFGdW5jdGlvbigpO1xuXG4gICAgLy9HcmFudCBMYW1iZGEgZnVuY3Rpb25zIHJlYWQvd3JpdGUgYWNjZXNzIHRvIFMzIGJ1Y2tldFxuICAgIHN0b3JhZ2VCdWNrZXQuZ3JhbnRSZWFkV3JpdGUoZ2V0QXNzZXRMYW1iZGEubGFtYmRhRnVuY3Rpb24pO1xuXG4gICAgLy9HcmFudCBMYW1iZGEgZnVuY3Rpb25zIHJlYWQvd3JpdGUgYWNjZXNzIHRvIEREQiB0YWJsZVxuICAgIHN0b3JhZ2VEYXRhYmFzZS5ncmFudFJlYWRXcml0ZURhdGEoZ2V0QXNzZXRMYW1iZGEubGFtYmRhRnVuY3Rpb24pO1xuICAgIGxlYWRlcmJvYXJkRGF0YWJhc2UuZ3JhbnRSZWFkRGF0YShnZXRIaWdoU2NvcmVMYW1iZGEubGFtYmRhRnVuY3Rpb24pO1xuICAgIGxlYWRlcmJvYXJkRGF0YWJhc2UuZ3JhbnRSZWFkV3JpdGVEYXRhKHB1dEhpZ2hTY29yZUxhbWJkYS5sYW1iZGFGdW5jdGlvbik7XG5cbiAgICAvLyBEZWZpbmUgYSBMYW1iZGEgZnVuY3Rpb25cblxuICAgIC8vQnVpbGQgQ29nbml0byBTdGFja1xuICAgIGNvbnN0IGNvZ25pdG9TdGFjayA9IG5ldyBDb2duaXRvU3RhY2soc2NvcGUsIFwiYXV0aFwiLCB0cnVlLCB0cnVlKTtcbiAgXG4gICAgLy9jb25zdCBhZG1pbkVtYWlsPWNvZ25pdG9TdGFjay5BZGRVc2VyKHNjb3BlLCBcIkFkbWluVXNlclwiLCBcIkFkbWluRW1haWxcIiwgY29nbml0b1N0YWNrLnVzZXJQb29sLnVzZXJQb29sSWQpXG4gIFxuICAgIC8vQnVpbGQgQVBJIEdhdGV3YXlcbiAgICBjb25zdCBhcGlHYXRld2F5ID0gbmV3IHJlc3RHYXRld2F5TmVzdGVkU3RhY2soc2NvcGUsIFwiZ2F0ZXdheVwiLCBcIk1haW4gU3RhY2sgR2F0ZXdheVwiLCBcImRldlwiKS5nYXRld2F5O1xuICAgIC8vIGFwaUdhdGV3YXkuQXR0YWNoV2ViQUNMKHNjb3BlLCBcImFwaWdBQ0xcIik7XG4gICAgY29uc3QgYXBpQXV0aG9yaXplciA9IGFwaUdhdGV3YXkuQWRkQ29nbml0b0F1dGhvcml6ZXIoc2NvcGUsIFwiQVBJX0F1dGhvcml6ZXJcIiwgW2NvZ25pdG9TdGFjay51c2VyUG9vbF0pXG4gICAgYXBpR2F0ZXdheS5BZGRNZXRob2RJbnRlZ3JhdGlvbihnZXRBc3NldExhbWJkYS5NZXRob2RJbnRlZ3JhdGlvbigpLCBcImFzc2V0c1wiLCBcIkdFVFwiLCBhcGlBdXRob3JpemVyKTtcbiAgICBhcGlHYXRld2F5LkFkZE1ldGhvZEludGVncmF0aW9uKHB1dEhpZ2hTY29yZUxhbWJkYS5NZXRob2RJbnRlZ3JhdGlvbigpLCBcImxlYWRlcmJvYXJkXCIsIFwiUE9TVFwiLCBhcGlBdXRob3JpemVyKTtcbiAgICBhcGlHYXRld2F5LkFkZE1ldGhvZEludGVncmF0aW9uKGdldEhpZ2hTY29yZUxhbWJkYS5NZXRob2RJbnRlZ3JhdGlvbigpLCBcImxlYWRlcmJvYXJkL3twbGF5ZXJJZH1cIiwgXCJHRVRcIiwgYXBpQXV0aG9yaXplcik7XG5cblxuICAgIC8vVXBsb2FkIFdlYnNpdGVcbiAgICBjb25zdCB3ZWJzaXRlID0gbmV3IFdlYlNpdGVEZXBsb3ltZW50KHNjb3BlLCBcIndlYkRlcGxveW1lbnRcIiwgJy4uLy4uL3dlYi9kaXN0JywgJ2luZGV4Lmh0bWwnLCBhcGlHYXRld2F5LCBzdG9yYWdlQnVja2V0KTtcbiAgICAvLyBjb25zdCBhcGlVUkwgPSB3ZWJzaXRlLkFkZERpc3RyaWJ1dGlvbkJlaGF2aW9yKCcvYXBpcy8qJywgbmV3IGNkay5hd3NfY2xvdWRmcm9udF9vcmlnaW5zLlJlc3RBcGlPcmlnaW4oYXBpR2F0ZXdheSwge30pKTtcbiAgICAvLyBhcGlHYXRld2F5LmFwaUdhdGV3YXlVUkwgPSB3ZWJzaXRlLmNsb3VkZnJvbnREaXN0cmlidXRpb24uZGlzdHJpYnV0aW9uRG9tYWluTmFtZSArIFwiL2FwaXNcIlxuICAgICBjb25zdCBjb25maWdKc29uID0ge1xuICAgIC8vICAgLi4uc3RvcmFnZUJ1Y2tldC5FeHBvcnRDb25maWcoKSxcbiAgICAvLyAgIC4uLmFwaUdhdGV3YXkuRXhwb3J0Q29uZmlnKCksXG4gICAgICAgICAuLi5jb2duaXRvU3RhY2suRXhwb3J0Q29uZmlnKClcbiAgICB9XG5cbiAgICAvLyBjb25zdCBjb25maWdHZW49bmV3IENvbmZpZ0dlbmVyYXRvcihzY29wZSwgJ0NvbmZpZ0dlbicsIGNvbmZpZ0pzb24pO1xuICAgIC8vIGNvbmZpZ0dlbi5ub2RlLmFkZERlcGVuZGVuY3koW3dlYnNpdGUuY2xvdWRmcm9udERpc3RyaWJ1dGlvbl0pO1xuICAgIGhlbHBlcnMuT3V0cHV0VmFyaWFibGUoc2NvcGUsIFwiUGFyYW1zXCIsIGNvbmZpZ0pzb24sIFwiQ29uZmlndXJhdGlvblwiKVxuICAgIGhlbHBlcnMuT3V0cHV0VmFyaWFibGUoc2NvcGUsIFwiQ0xJIFNldCBVc2VyIFBhc3N3b3JkIENvbW1hbmRcIiwgYGF3cyBjb2duaXRvLWlkcCBhZG1pbi1zZXQtdXNlci1wYXNzd29yZCAtLXVzZXItcG9vbC1pZCAke2NvZ25pdG9TdGFjay51c2VyUG9vbC51c2VyUG9vbElkfSAtLXBlcm1hbmVudCAtLXVzZXJuYW1lIHtpbnNlcnQgZW1haWx9IC0tcGFzc3dvcmQge2luc2VydCBwYXNzd29yZH1gLCBcIkNvbmZpZ3VyZSBhZG1pbiBwYXNzd29yZFwiKVxuICB9XG59XG4iXX0=