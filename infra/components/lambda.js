"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ConfigGenerator = exports.LambdaCustomResource = exports.LambdaFunctionConstruct = exports.LambdaStack = void 0;
const cdk = require("aws-cdk-lib");
const lambda = require("aws-cdk-lib/aws-lambda");
const apig = require("aws-cdk-lib/aws-apigateway");
const cr = require("aws-cdk-lib/custom-resources");
const path = require("path");
const s3_1 = require("./s3");
class LambdaStack extends cdk.NestedStack {
    constructor(scope, id, runTime, codePathString, mainFunc, timeOut, memory = 128, storage = 512, envs = {}, layers = []) {
        super(scope, id);
        this.lambdaFunction = new LambdaFunctionConstruct(scope, id + "_FUNC", runTime, codePathString, mainFunc, timeOut, memory, storage, envs, layers);
    }
    MethodIntegration() {
        return new apig.LambdaIntegration(this.lambdaFunction, { proxy: true });
    }
}
exports.LambdaStack = LambdaStack;
class LambdaFunctionConstruct extends lambda.Function {
    constructor(scope, id, runTime, codePathString, mainFunc, timeOut, memory = 128, storage = 512, envs = {}, layers = []) {
        const lambdaHandler = codePathString + mainFunc;
        //const lambdaHandler = codePathString.split("/").at(-1) + "." + mainFunc
        const props = {
            runtime: runTime,
            handler: lambdaHandler,
            code: lambda.Code.fromAsset(path.join(__dirname, codePathString)),
            timeout: timeOut ? timeOut : cdk.Duration.seconds(3),
            memorySize: memory,
            ephemeralStorageSize: cdk.Size.mebibytes(storage),
            environment: envs,
            layers: layers
        };
        super(scope, id, props);
    }
    MethodIntegration() {
        return new apig.LambdaIntegration(this, { proxy: true });
    }
}
exports.LambdaFunctionConstruct = LambdaFunctionConstruct;
class LambdaCustomResource extends LambdaFunctionConstruct {
    constructor(scope, id, runTime, codePathString, mainFunc, timeOut, memory = 128, storage = 512, envs = {}, bucket) {
        super(scope, id, runTime, codePathString, mainFunc, timeOut, memory, storage, envs);
        this.crp = new cr.Provider(scope, id + "_crp", {
            onEventHandler: this
        });
    }
    Execute(scope, id, properties) {
        return new cdk.CustomResource(scope, id, {
            serviceToken: this.crp.serviceToken,
            properties: {
                "Params": properties
            }
        });
    }
}
exports.LambdaCustomResource = LambdaCustomResource;
class ConfigGenerator extends LambdaCustomResource {
    constructor(scope, id, Configuration, existingBucket) {
        const configBucket = existingBucket ? existingBucket : new s3_1.S3Bucket(scope, id + "-ConfigBucket", cdk.RemovalPolicy.DESTROY);
        const envs = {
            'BucketName': configBucket.bucketName
        };
        super(scope, id, cdk.aws_lambda.Runtime.PYTHON_3_9, './component_scripts/configCreator', 'lambda_handler', undefined, undefined, undefined, envs);
        this.bucket = configBucket;
        this.bucket.grantWrite(this);
        this.Execute(scope, id + "_execute", Configuration);
    }
}
exports.ConfigGenerator = ConfigGenerator;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGFtYmRhLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsibGFtYmRhLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLG1DQUFtQztBQUNuQyxpREFBaUQ7QUFFakQsbURBQW1EO0FBQ25ELG1EQUFtRDtBQUNuRCw2QkFBOEI7QUFFOUIsNkJBQWdDO0FBRWhDLE1BQWEsV0FBWSxTQUFRLEdBQUcsQ0FBQyxXQUFXO0lBRTVDLFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsT0FBdUIsRUFBRSxjQUFzQixFQUFFLFFBQWdCLEVBQUUsT0FBc0IsRUFBRSxTQUFlLEdBQUcsRUFBRSxVQUFnQixHQUFHLEVBQUUsT0FBaUMsRUFBRSxFQUFFLFNBQThCLEVBQUU7UUFDL08sS0FBSyxDQUFDLEtBQUssRUFBQyxFQUFFLENBQUMsQ0FBQztRQUNoQixJQUFJLENBQUMsY0FBYyxHQUFHLElBQUksdUJBQXVCLENBQUMsS0FBSyxFQUFDLEVBQUUsR0FBQyxPQUFPLEVBQUMsT0FBTyxFQUFDLGNBQWMsRUFBQyxRQUFRLEVBQUMsT0FBTyxFQUFDLE1BQU0sRUFBQyxPQUFPLEVBQUMsSUFBSSxFQUFDLE1BQU0sQ0FBQyxDQUFBO0lBQzFJLENBQUM7SUFDRCxpQkFBaUI7UUFDYixPQUFPLElBQUksSUFBSSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUMsRUFBQyxLQUFLLEVBQUMsSUFBSSxFQUFDLENBQUMsQ0FBQztJQUN4RSxDQUFDO0NBQ0o7QUFURCxrQ0FTQztBQUVELE1BQWEsdUJBQXdCLFNBQVEsTUFBTSxDQUFDLFFBQVE7SUFDeEQsWUFBWSxLQUFnQixFQUFFLEVBQVUsRUFBRSxPQUF1QixFQUFFLGNBQXNCLEVBQUUsUUFBZ0IsRUFBRSxPQUFzQixFQUFFLFNBQWUsR0FBRyxFQUFFLFVBQWdCLEdBQUcsRUFBRSxPQUFpQyxFQUFFLEVBQUUsU0FBOEIsRUFBRTtRQUMvTyxNQUFNLGFBQWEsR0FBRyxjQUFjLEdBQUcsUUFBUSxDQUFDO1FB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Q0FZQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGNkayBmcm9tICdhd3MtY2RrLWxpYic7XG5pbXBvcnQgKiBhcyBsYW1iZGEgZnJvbSAnYXdzLWNkay1saWIvYXdzLWxhbWJkYSc7XG5pbXBvcnQgKiBhcyBoZWxwZXJzIGZyb20gJy4vaGVscGVyU2NyaXB0cyc7XG5pbXBvcnQgKiBhcyBhcGlnIGZyb20gJ2F3cy1jZGstbGliL2F3cy1hcGlnYXRld2F5JztcbmltcG9ydCAqIGFzIGNyIGZyb20gJ2F3cy1jZGstbGliL2N1c3RvbS1yZXNvdXJjZXMnO1xuaW1wb3J0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tICdjb25zdHJ1Y3RzJztcbmltcG9ydCB7IFMzQnVja2V0IH0gZnJvbSAnLi9zMyc7XG5cbmV4cG9ydCBjbGFzcyBMYW1iZGFTdGFjayBleHRlbmRzIGNkay5OZXN0ZWRTdGFjayB7XG4gICAgbGFtYmRhRnVuY3Rpb246bGFtYmRhLkZ1bmN0aW9uXG4gICAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcnVuVGltZTogbGFtYmRhLlJ1bnRpbWUsIGNvZGVQYXRoU3RyaW5nOiBzdHJpbmcsIG1haW5GdW5jOiBzdHJpbmcsIHRpbWVPdXQ/OiBjZGsuRHVyYXRpb24sIG1lbW9yeTogbnVtYmVyPTEyOCwgc3RvcmFnZTogbnVtYmVyPTUxMiwgZW52czogeyBba2V5OiBzdHJpbmddOiBzdHJpbmc7IH09e30sIGxheWVyczogbGFtYmRhLkxheWVyVmVyc2lvbltdPVtdKSB7XG4gICAgICAgIHN1cGVyKHNjb3BlLGlkKTtcbiAgICAgICAgdGhpcy5sYW1iZGFGdW5jdGlvbiA9IG5ldyBMYW1iZGFGdW5jdGlvbkNvbnN0cnVjdChzY29wZSxpZCtcIl9GVU5DXCIscnVuVGltZSxjb2RlUGF0aFN0cmluZyxtYWluRnVuYyx0aW1lT3V0LG1lbW9yeSxzdG9yYWdlLGVudnMsbGF5ZXJzKVxuICAgIH1cbiAgICBNZXRob2RJbnRlZ3JhdGlvbigpe1xuICAgICAgICByZXR1cm4gbmV3IGFwaWcuTGFtYmRhSW50ZWdyYXRpb24odGhpcy5sYW1iZGFGdW5jdGlvbix7cHJveHk6dHJ1ZX0pO1xuICAgIH1cbn1cblxuZXhwb3J0IGNsYXNzIExhbWJkYUZ1bmN0aW9uQ29uc3RydWN0IGV4dGVuZHMgbGFtYmRhLkZ1bmN0aW9uIHtcbiAgICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBydW5UaW1lOiBsYW1iZGEuUnVudGltZSwgY29kZVBhdGhTdHJpbmc6IHN0cmluZywgbWFpbkZ1bmM6IHN0cmluZywgdGltZU91dD86IGNkay5EdXJhdGlvbiwgbWVtb3J5OiBudW1iZXI9MTI4LCBzdG9yYWdlOiBudW1iZXI9NTEyLCBlbnZzOiB7IFtrZXk6IHN0cmluZ106IHN0cmluZzsgfT17fSwgbGF5ZXJzOiBsYW1iZGEuTGF5ZXJWZXJzaW9uW109W10pIHtcbiAgICAgICAgY29uc3QgbGFtYmRhSGFuZGxlciA9IGNvZGVQYXRoU3RyaW5nICsgbWFpbkZ1bmM7XG4gICAgICAgIC8vY29uc3QgbGFtYmRhSGFuZGxlciA9IGNvZGVQYXRoU3RyaW5nLnNwbGl0KFwiL1wiKS5hdCgtMSkgKyBcIi5cIiArIG1haW5GdW5jXG4gICAgICAgIGNvbnN0IHByb3BzID0ge1xuICAgICAgICAgICAgcnVudGltZTogcnVuVGltZSxcbiAgICAgICAgICAgIGhhbmRsZXI6IGxhbWJkYUhhbmRsZXIsXG4gICAgICAgICAgICBjb2RlOiBsYW1iZGEuQ29kZS5mcm9tQXNzZXQocGF0aC5qb2luKF9fZGlybmFtZSwgY29kZVBhdGhTdHJpbmcpKSxcbiAgICAgICAgICAgIHRpbWVvdXQ6IHRpbWVPdXQgPyB0aW1lT3V0IDogY2RrLkR1cmF0aW9uLnNlY29uZHMoMyksXG4gICAgICAgICAgICBtZW1vcnlTaXplOiBtZW1vcnksXG4gICAgICAgICAgICBlcGhlbWVyYWxTdG9yYWdlU2l6ZTogY2RrLlNpemUubWViaWJ5dGVzKHN0b3JhZ2UpLFxuICAgICAgICAgICAgZW52aXJvbm1lbnQ6IGVudnMsXG4gICAgICAgICAgICBsYXllcnM6IGxheWVyc1xuICAgICAgICB9XG4gICAgICAgIHN1cGVyKHNjb3BlLGlkLHByb3BzKTtcbiAgICB9XG4gICAgTWV0aG9kSW50ZWdyYXRpb24oKXtcbiAgICAgICAgcmV0dXJuIG5ldyBhcGlnLkxhbWJkYUludGVncmF0aW9uKHRoaXMsIHsgcHJveHk6IHRydWUgfSkgICBcbiAgICB9XG59XG5leHBvcnQgY2xhc3MgTGFtYmRhQ3VzdG9tUmVzb3VyY2UgZXh0ZW5kcyBMYW1iZGFGdW5jdGlvbkNvbnN0cnVjdHtcbiAgICBjcnA6IGNyLlByb3ZpZGVyXG4gICAgbGFtYmRhRnVuY3Rpb246IGxhbWJkYS5GdW5jdGlvblxuICAgIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHJ1blRpbWU6IGxhbWJkYS5SdW50aW1lLCBjb2RlUGF0aFN0cmluZzogc3RyaW5nLCBtYWluRnVuYzogc3RyaW5nLCB0aW1lT3V0PzogY2RrLkR1cmF0aW9uLG1lbW9yeTpudW1iZXI9MTI4LHN0b3JhZ2U6bnVtYmVyPTUxMixlbnZzOiB7IFtrZXk6IHN0cmluZ106IHN0cmluZzsgfT17fSxidWNrZXQ/OmNkay5hd3NfczMuQnVja2V0KSB7XG4gICAgICAgIHN1cGVyKHNjb3BlLGlkLHJ1blRpbWUsY29kZVBhdGhTdHJpbmcsbWFpbkZ1bmMsdGltZU91dCxtZW1vcnksc3RvcmFnZSxlbnZzKVxuICAgICAgICB0aGlzLmNycCA9IG5ldyBjci5Qcm92aWRlcihzY29wZSwgaWQrXCJfY3JwXCIsIHtcbiAgICAgICAgICAgIG9uRXZlbnRIYW5kbGVyOiB0aGlzXG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBFeGVjdXRlKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BlcnRpZXM6IG9iamVjdCkge1xuICAgICAgICByZXR1cm4gbmV3IGNkay5DdXN0b21SZXNvdXJjZShzY29wZSwgaWQsIHtcbiAgICAgICAgICAgIHNlcnZpY2VUb2tlbjogdGhpcy5jcnAuc2VydmljZVRva2VuLFxuICAgICAgICAgICAgcHJvcGVydGllczoge1xuICAgICAgICAgICAgICAgIFwiUGFyYW1zXCI6IHByb3BlcnRpZXNcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxufVxuZXhwb3J0IGNsYXNzIENvbmZpZ0dlbmVyYXRvciBleHRlbmRzIExhbWJkYUN1c3RvbVJlc291cmNle1xuICAgIGJ1Y2tldDpjZGsuYXdzX3MzLkJ1Y2tldDtcbiAgICBjb25zdHJ1Y3RvcihzY29wZTpDb25zdHJ1Y3QsaWQ6c3RyaW5nLENvbmZpZ3VyYXRpb246b2JqZWN0LGV4aXN0aW5nQnVja2V0PzpjZGsuYXdzX3MzLkJ1Y2tldCl7XG4gICAgICAgIGNvbnN0IGNvbmZpZ0J1Y2tldD1leGlzdGluZ0J1Y2tldD9leGlzdGluZ0J1Y2tldDpuZXcgUzNCdWNrZXQoc2NvcGUsaWQrXCItQ29uZmlnQnVja2V0XCIsY2RrLlJlbW92YWxQb2xpY3kuREVTVFJPWSlcbiAgICAgICAgY29uc3QgZW52cz17XG4gICAgICAgICAgICAnQnVja2V0TmFtZSc6Y29uZmlnQnVja2V0LmJ1Y2tldE5hbWVcbiAgICAgICAgfTtcbiAgICAgICAgc3VwZXIoc2NvcGUsaWQsY2RrLmF3c19sYW1iZGEuUnVudGltZS5QWVRIT05fM185LCcuL2NvbXBvbmVudF9zY3JpcHRzL2NvbmZpZ0NyZWF0b3InLCdsYW1iZGFfaGFuZGxlcicsdW5kZWZpbmVkLHVuZGVmaW5lZCx1bmRlZmluZWQsZW52cylcbiAgICAgICAgdGhpcy5idWNrZXQ9Y29uZmlnQnVja2V0O1xuICAgICAgICB0aGlzLmJ1Y2tldC5ncmFudFdyaXRlKHRoaXMpO1xuICAgICAgICB0aGlzLkV4ZWN1dGUoc2NvcGUsaWQrXCJfZXhlY3V0ZVwiLENvbmZpZ3VyYXRpb24pO1xuICAgIH1cbn1cbiJdfQ==