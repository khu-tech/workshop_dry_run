"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ConfigGenerator = exports.LambdaCustomResource = exports.LambdaFunctionConstruct = exports.LambdaStack = void 0;
const cdk = require("aws-cdk-lib");
const lambda = require("aws-cdk-lib/aws-lambda");
const apig = require("aws-cdk-lib/aws-apigateway");
const cr = require("aws-cdk-lib/custom-resources");
const path = require("path");
const s3_1 = require("./s3");
class LambdaStack extends cdk.NestedStack {
    constructor(scope, id, runTime, codePathString, mainFunc, timeOut, memory = 128, storage = 512, envs = {}, layers = []) {
        super(scope, id);
        this.lambdaFunction = new LambdaFunctionConstruct(scope, id + "_FUNC", runTime, codePathString, mainFunc, timeOut, memory, storage, envs, layers);
    }
    MethodIntegration() {
        return new apig.LambdaIntegration(this.lambdaFunction, { proxy: true });
    }
    getLambdaFunction() {
        return this.lambdaFunction;
    }
}
exports.LambdaStack = LambdaStack;
class LambdaFunctionConstruct extends lambda.Function {
    constructor(scope, id, runTime, codePathString, mainFunc, timeOut, memory = 128, storage = 512, envs = {}, layers = []) {
        const pathArray = codePathString.split("/");
        const lambdaHandler = pathArray[pathArray.length - 1] + "." + mainFunc;
        const props = {
            runtime: runTime,
            handler: lambdaHandler,
            code: lambda.Code.fromAsset(path.join(__dirname, codePathString)),
            timeout: timeOut ? timeOut : cdk.Duration.seconds(3),
            memorySize: memory,
            ephemeralStorageSize: cdk.Size.mebibytes(storage),
            environment: envs,
            layers: layers
        };
        super(scope, id, props);
    }
    MethodIntegration() {
        return new apig.LambdaIntegration(this, { proxy: true });
    }
}
exports.LambdaFunctionConstruct = LambdaFunctionConstruct;
class LambdaCustomResource extends LambdaFunctionConstruct {
    constructor(scope, id, runTime, codePathString, mainFunc, timeOut, memory = 128, storage = 512, envs = {}, bucket) {
        super(scope, id, runTime, codePathString, mainFunc, timeOut, memory, storage, envs);
        this.crp = new cr.Provider(scope, id + "_crp", {
            onEventHandler: this
        });
    }
    Execute(scope, id, properties) {
        return new cdk.CustomResource(scope, id, {
            serviceToken: this.crp.serviceToken,
            properties: {
                "Params": properties
            }
        });
    }
}
exports.LambdaCustomResource = LambdaCustomResource;
class ConfigGenerator extends LambdaCustomResource {
    constructor(scope, id, Configuration, existingBucket) {
        const configBucket = existingBucket ? existingBucket : new s3_1.S3Bucket(scope, id + "-ConfigBucket", cdk.RemovalPolicy.DESTROY);
        const envs = {
            'BucketName': configBucket.bucketName
        };
        super(scope, id, cdk.aws_lambda.Runtime.PYTHON_3_9, './component_scripts/configCreator', 'lambda_handler', undefined, undefined, undefined, envs);
        this.bucket = configBucket;
        this.bucket.grantWrite(this);
        this.Execute(scope, id + "_execute", Configuration);
    }
}
exports.ConfigGenerator = ConfigGenerator;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGFtYmRhLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsibGFtYmRhLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLG1DQUFtQztBQUNuQyxpREFBaUQ7QUFFakQsbURBQW1EO0FBQ25ELG1EQUFtRDtBQUVuRCw2QkFBOEI7QUFFOUIsNkJBQWdDO0FBR2hDLE1BQWEsV0FBWSxTQUFRLEdBQUcsQ0FBQyxXQUFXO0lBRTVDLFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsT0FBdUIsRUFBRSxjQUFzQixFQUFFLFFBQWdCLEVBQUUsT0FBc0IsRUFBRSxTQUFlLEdBQUcsRUFBRSxVQUFnQixHQUFHLEVBQUUsT0FBaUMsRUFBRSxFQUFFLFNBQThCLEVBQUU7UUFDL08sS0FBSyxDQUFDLEtBQUssRUFBQyxFQUFFLENBQUMsQ0FBQztRQUNoQixJQUFJLENBQUMsY0FBYyxHQUFHLElBQUksdUJBQXVCLENBQUMsS0FBSyxFQUFDLEVBQUUsR0FBQyxPQUFPLEVBQUMsT0FBTyxFQUFDLGNBQWMsRUFBQyxRQUFRLEVBQUMsT0FBTyxFQUFDLE1BQU0sRUFBQyxPQUFPLEVBQUMsSUFBSSxFQUFDLE1BQU0sQ0FBQyxDQUFBO0lBQzFJLENBQUM7SUFDRCxpQkFBaUI7UUFDYixPQUFPLElBQUksSUFBSSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUMsRUFBQyxLQUFLLEVBQUMsSUFBSSxFQUFDLENBQUMsQ0FBQztJQUN4RSxDQUFDO0lBQ00saUJBQWlCO1FBQ3BCLE9BQU8sSUFBSSxDQUFDLGNBQWMsQ0FBQztJQUMvQixDQUFDO0NBQ0o7QUFaRCxrQ0FZQztBQUVELE1BQWEsdUJBQXdCLFNBQVEsTUFBTSxDQUFDLFFBQVE7SUFDeEQsWUFBWSxLQUFnQixFQUFFLEVBQVUsRUFBRSxPQUF1QixFQUFFLGNBQXNCLEVBQUUsUUFBZ0IsRUFBRSxPQUFzQixFQUFFLFNBQWUsR0FBRyxFQUFFLFVBQWdCLEdBQUcsRUFBRSxPQUFpQyxFQUFFLEVBQUUs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Q3pCLElBQUksQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzdCLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFDLEVBQUUsR0FBQyxVQUFVLEVBQUMsYUFBYSxDQUFDLENBQUM7SUFDcEQsQ0FBQztDQUNKO0FBWkQsMENBWUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBjZGsgZnJvbSAnYXdzLWNkay1saWInO1xuaW1wb3J0ICogYXMgbGFtYmRhIGZyb20gJ2F3cy1jZGstbGliL2F3cy1sYW1iZGEnO1xuaW1wb3J0ICogYXMgaGVscGVycyBmcm9tICcuL2hlbHBlclNjcmlwdHMnO1xuaW1wb3J0ICogYXMgYXBpZyBmcm9tICdhd3MtY2RrLWxpYi9hd3MtYXBpZ2F0ZXdheSc7XG5pbXBvcnQgKiBhcyBjciBmcm9tICdhd3MtY2RrLWxpYi9jdXN0b20tcmVzb3VyY2VzJztcbmltcG9ydCAqIGFzIGlhbSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtaWFtJztcbmltcG9ydCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSAnY29uc3RydWN0cyc7XG5pbXBvcnQgeyBTM0J1Y2tldCB9IGZyb20gJy4vczMnO1xuaW1wb3J0IHtDb2duaXRvU3RhY2t9IGZyb20gXCIuL2NvZ25pdG9cIjtcblxuZXhwb3J0IGNsYXNzIExhbWJkYVN0YWNrIGV4dGVuZHMgY2RrLk5lc3RlZFN0YWNrIHtcbiAgICBsYW1iZGFGdW5jdGlvbjpsYW1iZGEuRnVuY3Rpb25cbiAgICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBydW5UaW1lOiBsYW1iZGEuUnVudGltZSwgY29kZVBhdGhTdHJpbmc6IHN0cmluZywgbWFpbkZ1bmM6IHN0cmluZywgdGltZU91dD86IGNkay5EdXJhdGlvbiwgbWVtb3J5OiBudW1iZXI9MTI4LCBzdG9yYWdlOiBudW1iZXI9NTEyLCBlbnZzOiB7IFtrZXk6IHN0cmluZ106IHN0cmluZzsgfT17fSwgbGF5ZXJzOiBsYW1iZGEuTGF5ZXJWZXJzaW9uW109W10pIHtcbiAgICAgICAgc3VwZXIoc2NvcGUsaWQpO1xuICAgICAgICB0aGlzLmxhbWJkYUZ1bmN0aW9uID0gbmV3IExhbWJkYUZ1bmN0aW9uQ29uc3RydWN0KHNjb3BlLGlkK1wiX0ZVTkNcIixydW5UaW1lLGNvZGVQYXRoU3RyaW5nLG1haW5GdW5jLHRpbWVPdXQsbWVtb3J5LHN0b3JhZ2UsZW52cyxsYXllcnMpXG4gICAgfVxuICAgIE1ldGhvZEludGVncmF0aW9uKCl7XG4gICAgICAgIHJldHVybiBuZXcgYXBpZy5MYW1iZGFJbnRlZ3JhdGlvbih0aGlzLmxhbWJkYUZ1bmN0aW9uLHtwcm94eTp0cnVlfSk7XG4gICAgfVxuICAgIHB1YmxpYyBnZXRMYW1iZGFGdW5jdGlvbigpOiBsYW1iZGEuSUZ1bmN0aW9uIHtcbiAgICAgICAgcmV0dXJuIHRoaXMubGFtYmRhRnVuY3Rpb247XG4gICAgfVxufVxuXG5leHBvcnQgY2xhc3MgTGFtYmRhRnVuY3Rpb25Db25zdHJ1Y3QgZXh0ZW5kcyBsYW1iZGEuRnVuY3Rpb24ge1xuICAgIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHJ1blRpbWU6IGxhbWJkYS5SdW50aW1lLCBjb2RlUGF0aFN0cmluZzogc3RyaW5nLCBtYWluRnVuYzogc3RyaW5nLCB0aW1lT3V0PzogY2RrLkR1cmF0aW9uLCBtZW1vcnk6IG51bWJlcj0xMjgsIHN0b3JhZ2U6IG51bWJlcj01MTIsIGVudnM6IHsgW2tleTogc3RyaW5nXTogc3RyaW5nOyB9PXt9LCBsYXllcnM6IGxhbWJkYS5MYXllclZlcnNpb25bXT1bXSkge1xuICAgICAgICBjb25zdCBwYXRoQXJyYXkgPSBjb2RlUGF0aFN0cmluZy5zcGxpdChcIi9cIik7XG4gICAgICAgIGNvbnN0IGxhbWJkYUhhbmRsZXIgPSBwYXRoQXJyYXlbcGF0aEFycmF5Lmxlbmd0aCAtIDFdICsgXCIuXCIgKyBtYWluRnVuY1xuICAgICAgICBjb25zdCBwcm9wcyA9IHtcbiAgICAgICAgICAgIHJ1bnRpbWU6IHJ1blRpbWUsXG4gICAgICAgICAgICBoYW5kbGVyOiBsYW1iZGFIYW5kbGVyLFxuICAgICAgICAgICAgY29kZTogbGFtYmRhLkNvZGUuZnJvbUFzc2V0KHBhdGguam9pbihfX2Rpcm5hbWUsIGNvZGVQYXRoU3RyaW5nKSksXG4gICAgICAgICAgICB0aW1lb3V0OiB0aW1lT3V0ID8gdGltZU91dCA6IGNkay5EdXJhdGlvbi5zZWNvbmRzKDMpLFxuICAgICAgICAgICAgbWVtb3J5U2l6ZTogbWVtb3J5LFxuICAgICAgICAgICAgZXBoZW1lcmFsU3RvcmFnZVNpemU6IGNkay5TaXplLm1lYmlieXRlcyhzdG9yYWdlKSxcbiAgICAgICAgICAgIGVudmlyb25tZW50OiBlbnZzLFxuICAgICAgICAgICAgbGF5ZXJzOiBsYXllcnNcbiAgICAgICAgfVxuICAgICAgICBzdXBlcihzY29wZSxpZCxwcm9wcyk7XG4gICAgfVxuXG4gICAgTWV0aG9kSW50ZWdyYXRpb24oKXtcbiAgICAgICAgcmV0dXJuIG5ldyBhcGlnLkxhbWJkYUludGVncmF0aW9uKHRoaXMsIHsgcHJveHk6IHRydWUgfSkgICBcbiAgICB9XG59XG5leHBvcnQgY2xhc3MgTGFtYmRhQ3VzdG9tUmVzb3VyY2UgZXh0ZW5kcyBMYW1iZGFGdW5jdGlvbkNvbnN0cnVjdHtcbiAgICBjcnA6IGNyLlByb3ZpZGVyXG4gICAgbGFtYmRhRnVuY3Rpb246IGxhbWJkYS5GdW5jdGlvblxuICAgIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHJ1blRpbWU6IGxhbWJkYS5SdW50aW1lLCBjb2RlUGF0aFN0cmluZzogc3RyaW5nLCBtYWluRnVuYzogc3RyaW5nLCB0aW1lT3V0PzogY2RrLkR1cmF0aW9uLG1lbW9yeTpudW1iZXI9MTI4LHN0b3JhZ2U6bnVtYmVyPTUxMixlbnZzOiB7IFtrZXk6IHN0cmluZ106IHN0cmluZzsgfT17fSxidWNrZXQ/OmNkay5hd3NfczMuQnVja2V0KSB7XG4gICAgICAgIHN1cGVyKHNjb3BlLGlkLHJ1blRpbWUsY29kZVBhdGhTdHJpbmcsbWFpbkZ1bmMsdGltZU91dCxtZW1vcnksc3RvcmFnZSxlbnZzKVxuICAgICAgICB0aGlzLmNycCA9IG5ldyBjci5Qcm92aWRlcihzY29wZSwgaWQrXCJfY3JwXCIsIHtcbiAgICAgICAgICAgIG9uRXZlbnRIYW5kbGVyOiB0aGlzXG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBFeGVjdXRlKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BlcnRpZXM6IG9iamVjdCkge1xuICAgICAgICByZXR1cm4gbmV3IGNkay5DdXN0b21SZXNvdXJjZShzY29wZSwgaWQsIHtcbiAgICAgICAgICAgIHNlcnZpY2VUb2tlbjogdGhpcy5jcnAuc2VydmljZVRva2VuLFxuICAgICAgICAgICAgcHJvcGVydGllczoge1xuICAgICAgICAgICAgICAgIFwiUGFyYW1zXCI6IHByb3BlcnRpZXNcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxufVxuZXhwb3J0IGNsYXNzIENvbmZpZ0dlbmVyYXRvciBleHRlbmRzIExhbWJkYUN1c3RvbVJlc291cmNle1xuICAgIGJ1Y2tldDpjZGsuYXdzX3MzLkJ1Y2tldDtcbiAgICBjb25zdHJ1Y3RvcihzY29wZTpDb25zdHJ1Y3QsaWQ6c3RyaW5nLENvbmZpZ3VyYXRpb246b2JqZWN0LGV4aXN0aW5nQnVja2V0PzpjZGsuYXdzX3MzLkJ1Y2tldCl7XG4gICAgICAgIGNvbnN0IGNvbmZpZ0J1Y2tldD1leGlzdGluZ0J1Y2tldD9leGlzdGluZ0J1Y2tldDpuZXcgUzNCdWNrZXQoc2NvcGUsaWQrXCItQ29uZmlnQnVja2V0XCIsY2RrLlJlbW92YWxQb2xpY3kuREVTVFJPWSlcbiAgICAgICAgY29uc3QgZW52cz17XG4gICAgICAgICAgICAnQnVja2V0TmFtZSc6Y29uZmlnQnVja2V0LmJ1Y2tldE5hbWVcbiAgICAgICAgfTtcbiAgICAgICAgc3VwZXIoc2NvcGUsaWQsY2RrLmF3c19sYW1iZGEuUnVudGltZS5QWVRIT05fM185LCcuL2NvbXBvbmVudF9zY3JpcHRzL2NvbmZpZ0NyZWF0b3InLCdsYW1iZGFfaGFuZGxlcicsdW5kZWZpbmVkLHVuZGVmaW5lZCx1bmRlZmluZWQsZW52cylcbiAgICAgICAgdGhpcy5idWNrZXQ9Y29uZmlnQnVja2V0O1xuICAgICAgICB0aGlzLmJ1Y2tldC5ncmFudFdyaXRlKHRoaXMpO1xuICAgICAgICB0aGlzLkV4ZWN1dGUoc2NvcGUsaWQrXCJfZXhlY3V0ZVwiLENvbmZpZ3VyYXRpb24pO1xuICAgIH1cbn1cbiJdfQ==