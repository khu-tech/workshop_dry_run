"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.restGateway = exports.restGatewayNestedStack = void 0;
const cdk = require("aws-cdk-lib");
const apig = require("aws-cdk-lib/aws-apigateway");
const helpers = require("./helperScripts");
class restGatewayNestedStack extends cdk.NestedStack {
    constructor(scope, id, description, stageName) {
        super(scope, id);
        this.gateway = new restGateway(scope, id + "_G", description, stageName);
    }
}
exports.restGatewayNestedStack = restGatewayNestedStack;
class restGateway extends apig.RestApi {
    constructor(scope, id, description, stageName = "dev") {
        const props = {
            description: description ? description : 'API Gateway Construct',
            deployOptions: {
                stageName: stageName ? stageName : 'dev',
            },
        };
        super(scope, id, props);
        this.knownResources = {};
        this.scope = scope;
        this.id = id;
        this.apiGatewayURL = this.url;
        this.stageName = stageName;
        helpers.OutputVariable(scope, 'API Rest URL', this.url, "Restful API Gateway URL");
    }
    addCorsOptions(resource) {
        resource.addMethod('OPTIONS', new apig.MockIntegration({
            integrationResponses: [{
                    statusCode: '200',
                    responseParameters: {
                        'method.response.header.Access-Control-Allow-Headers': "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,AuthToken'",
                        'method.response.header.Access-Control-Allow-Methods': "'OPTIONS,GET,PUT,POST,DELETE'",
                        'method.response.header.Access-Control-Allow-Credentials': "'false'",
                        'method.response.header.Access-Control-Allow-Origin': "'*'",
                    },
                }],
            passthroughBehavior: apig.PassthroughBehavior.NEVER,
            requestTemplates: {
                "application/json": "{\"statusCode\": 200}"
            },
        }), {
            methodResponses: [{
                    statusCode: '200',
                    responseParameters: {
                        'method.response.header.Access-Control-Allow-Headers': true,
                        'method.response.header.Access-Control-Allow-Methods': true,
                        'method.response.header.Access-Control-Allow-Credentials': true,
                        'method.response.header.Access-Control-Allow-Origin': true,
                    },
                }]
        });
    }
    GetAPIGatewayArn() {
        // return `arn:aws:execute-api:${this.env.region}:${this.env.account}:${this.restApiId}/dev`
        return `arn:aws:apigateway:${this.env.region}::/restapis/${this.restApiId}/stages/${this.stageName}`;
    }
    AddCognitoAuthorizer(scope, id, UserPools) {
        const auth = new apig.CognitoUserPoolsAuthorizer(scope, id, {
            cognitoUserPools: UserPools
        });
        return auth;
    }
    AddAPIGAuthorizer(scope, id, authFn) {
        const auth = new apig.RequestAuthorizer(scope, id, {
            handler: authFn,
            identitySources: [apig.IdentitySource.header('Authorization')]
        });
        return auth;
    }
    AddResource(FullPath) {
        //Check if there is already a resource.
        if (this.knownResources[FullPath] !== undefined) {
            return this.knownResources[FullPath];
        }
        //Split up the path.
        //check if the base resources already exist, and then return the last one.
        const rootPath = this.root;
        const parts = FullPath.split("/");
        let currentResource = this.knownResources[parts[0]];
        if (this.knownResources[parts[0]] !== undefined) {
            currentResource = this.knownResources[parts[0]];
        }
        else {
            currentResource = rootPath.addResource(parts[0]);
            this.knownResources[parts[0]] = currentResource;
        }
        if (parts.length > 1) {
            for (let i = 1; i < parts.length; i++) {
                let currentPath = parts.slice(0, i).join("/");
                console.log(currentPath);
                try {
                    currentResource = currentResource.addResource(parts[i]);
                    this.knownResources[currentPath] = currentResource;
                }
                catch {
                    currentResource = this.knownResources[currentPath];
                }
            }
        }
        this.addCorsOptions(currentResource);
        return currentResource;
    }
    AddMethodIntegration(integration, route = "", methodString, auth) {
        const resource = this.AddResource(route);
        const method = resource.addMethod(methodString, integration, {
            authorizer: auth,
            authorizationType: auth.authorizationType
        });
        return true;
    }
    AttachWebACL(scope, id) {
        const webACL = this.GetWebACL(scope, id);
        return new cdk.aws_wafv2.CfnWebACLAssociation(this, this.id + '_CDKWebACLAssoc', {
            webAclArn: webACL.attrArn,
            resourceArn: this.GetAPIGatewayArn()
        });
    }
    GetWebACL(scope, id) {
        const wafWebACL = new cdk.aws_wafv2.CfnWebACL(scope, id + "_WebACL", {
            description: "BasicWAF",
            defaultAction: {
                allow: {},
            },
            scope: "REGIONAL",
            visibilityConfig: {
                cloudWatchMetricsEnabled: true,
                metricName: "WAFACLGLOBAL",
                sampledRequestsEnabled: true
            }
        });
        return wafWebACL;
    }
    ExportConfig() {
        return {
            API: {
                endpoints: [
                    {
                        name: this.restApiName,
                        endpoint: this.apiGatewayURL,
                        region: this.env.region
                    },
                ],
            }
        };
    }
}
exports.restGateway = restGateway;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBpZ2F0ZXdheS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImFwaWdhdGV3YXkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsbUNBQW1DO0FBQ25DLG1EQUFtRDtBQUduRCwyQ0FBMkM7QUFHM0MsTUFBYSxzQkFBdUIsU0FBUSxHQUFHLENBQUMsV0FBVztJQUV2RCxZQUFZLEtBQWdCLEVBQUUsRUFBVSxFQUFFLFdBQW9CLEVBQUUsU0FBa0I7UUFDOUUsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQTtRQUNoQixJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksV0FBVyxDQUFDLEtBQUssRUFBRSxFQUFFLEdBQUcsSUFBSSxFQUFFLFdBQVcsRUFBRSxTQUFTLENBQUMsQ0FBQTtJQUM1RSxDQUFDO0NBQ0o7QUFORCx3REFNQztBQUNELE1BQWEsV0FBWSxTQUFRLElBQUksQ0FBQyxPQUFPO0lBT3pDLFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsV0FBb0IsRUFBRSxZQUFvQixLQUFLO1FBQ3JGLE1BQU0sS0FBSyxHQUNYO1lBQ0ksV0FBVyxFQUFFLFdBQVcsQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyx1QkFBdUI7WUFDaEUsYUFBYSxFQUFFO2dCQUNYLFNBQVMsRUFBRSxTQUFTLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsS0FBSzthQUMzQztTQUNKLENBQUM7UUFFRixLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQTtRQVgzQixtQkFBYyxHQUFxQyxFQUFFLENBQUM7UUFZbEQsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7UUFDbkIsSUFBSSxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUM7UUFDYixJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUM7UUFDOUIsSUFBSSxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUM7UUFDM0IsT0FB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TSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQ3pDLE9BQU8sSUFBSSxHQUFHLENBQUMsU0FBUyxDQUFDLG9CQUFvQixDQUN6QyxJQUFJLEVBQ0osSUFBSSxDQUFDLEVBQUUsR0FBRyxpQkFBaUIsRUFDM0I7WUFDSSxTQUFTLEVBQUUsTUFBTSxDQUFDLE9BQU87WUFDekIsV0FBVyxFQUFFLElBQUksQ0FBQyxnQkFBZ0IsRUFBRTtTQUN2QyxDQUNKLENBQUM7SUFDTixDQUFDO0lBQ0QsU0FBUyxDQUFDLEtBQWdCLEVBQUUsRUFBVTtRQUNsQyxNQUFNLFNBQVMsR0FBRyxJQUFJLEdBQUcsQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUFDLEtBQUssRUFBRSxFQUFFLEdBQUcsU0FBUyxFQUMvRDtZQUNJLFdBQVcsRUFBRSxVQUFVO1lBQ3ZCLGFBQWEsRUFBRTtnQkFDWCxLQUFLLEVBQUUsRUFBRTthQUNaO1lBQ0QsS0FBSyxFQUFFLFVBQVU7WUFDakIsZ0JBQWdCLEVBQUU7Z0JBQ2Qsd0JBQXdCLEVBQUUsSUFBSTtnQkFDOUIsVUFBVSxFQUFFLGNBQWM7Z0JBQzFCLHNCQUFzQixFQUFFLElBQUk7YUFDL0I7U0FDSixDQUFDLENBQUM7UUFDUCxPQUFPLFNBQVMsQ0FBQTtJQUNwQixDQUFDO0lBQ0QsWUFBWTtRQUNSLE9BQU87WUFDSCxHQUFHLEVBQUU7Z0JBQ0QsU0FBUyxFQUFFO29CQUNQO3dCQUNJLElBQUksRUFBRSxJQUFJLENBQUMsV0FBVzt3QkFDdEIsUUFBUSxFQUFFLElBQUksQ0FBQyxhQUFhO3dCQUM1QixNQUFNLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNO3FCQUMxQjtpQkFDSjthQUNKO1NBQ0osQ0FBQTtJQUNMLENBQUM7Q0FDSjtBQTFKRCxrQ0EwSkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBjZGsgZnJvbSAnYXdzLWNkay1saWInO1xuaW1wb3J0ICogYXMgYXBpZyBmcm9tICdhd3MtY2RrLWxpYi9hd3MtYXBpZ2F0ZXdheSc7XG5pbXBvcnQgKiBhcyBjb2duaXRvIGZyb20gJ2F3cy1jZGstbGliL2F3cy1jb2duaXRvJztcbmltcG9ydCAqIGFzIGxhbWJkYSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtbGFtYmRhJztcbmltcG9ydCAqIGFzIGhlbHBlcnMgZnJvbSAnLi9oZWxwZXJTY3JpcHRzJztcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gJ2NvbnN0cnVjdHMnO1xuXG5leHBvcnQgY2xhc3MgcmVzdEdhdGV3YXlOZXN0ZWRTdGFjayBleHRlbmRzIGNkay5OZXN0ZWRTdGFjayB7XG4gICAgZ2F0ZXdheTogcmVzdEdhdGV3YXk7XG4gICAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgZGVzY3JpcHRpb24/OiBzdHJpbmcsIHN0YWdlTmFtZT86IHN0cmluZykge1xuICAgICAgICBzdXBlcihzY29wZSwgaWQpXG4gICAgICAgIHRoaXMuZ2F0ZXdheSA9IG5ldyByZXN0R2F0ZXdheShzY29wZSwgaWQgKyBcIl9HXCIsIGRlc2NyaXB0aW9uLCBzdGFnZU5hbWUpXG4gICAgfVxufVxuZXhwb3J0IGNsYXNzIHJlc3RHYXRld2F5IGV4dGVuZHMgYXBpZy5SZXN0QXBpIHtcbiAgICBzY29wZTogQ29uc3RydWN0O1xuICAgIGlkOiBTdHJpbmc7XG4gICAgYXBpR2F0ZXdheUFSTjogc3RyaW5nXG4gICAgYXBpR2F0ZXdheVVSTDogc3RyaW5nXG4gICAga25vd25SZXNvdXJjZXM6IHsgW2tleTogc3RyaW5nXTogYXBpZy5SZXNvdXJjZSB9ID0ge307XG4gICAgc3RhZ2VOYW1lOiBzdHJpbmdcbiAgICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBkZXNjcmlwdGlvbj86IHN0cmluZywgc3RhZ2VOYW1lOiBzdHJpbmcgPSBcImRldlwiKSB7XG4gICAgICAgIGNvbnN0IHByb3BzID1cbiAgICAgICAge1xuICAgICAgICAgICAgZGVzY3JpcHRpb246IGRlc2NyaXB0aW9uID8gZGVzY3JpcHRpb24gOiAnQVBJIEdhdGV3YXkgQ29uc3RydWN0JyxcbiAgICAgICAgICAgIGRlcGxveU9wdGlvbnM6IHtcbiAgICAgICAgICAgICAgICBzdGFnZU5hbWU6IHN0YWdlTmFtZSA/IHN0YWdlTmFtZSA6ICdkZXYnLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgfTtcblxuICAgICAgICBzdXBlcihzY29wZSwgaWQsIHByb3BzKVxuICAgICAgICB0aGlzLnNjb3BlID0gc2NvcGU7XG4gICAgICAgIHRoaXMuaWQgPSBpZDtcbiAgICAgICAgdGhpcy5hcGlHYXRld2F5VVJMID0gdGhpcy51cmw7XG4gICAgICAgIHRoaXMuc3RhZ2VOYW1lID0gc3RhZ2VOYW1lO1xuICAgICAgICBoZWxwZXJzLk91dHB1dFZhcmlhYmxlKHNjb3BlLCAnQVBJIFJlc3QgVVJMJywgdGhpcy51cmwsIFwiUmVzdGZ1bCBBUEkgR2F0ZXdheSBVUkxcIik7XG4gICAgfVxuXG4gICAgYWRkQ29yc09wdGlvbnMocmVzb3VyY2U6IGFwaWcuUmVzb3VyY2UpIHtcbiAgICAgICAgcmVzb3VyY2UuYWRkTWV0aG9kKCdPUFRJT05TJywgbmV3IGFwaWcuTW9ja0ludGVncmF0aW9uKHtcbiAgICAgICAgICAgIGludGVncmF0aW9uUmVzcG9uc2VzOiBbe1xuICAgICAgICAgICAgICAgIHN0YXR1c0NvZGU6ICcyMDAnLFxuICAgICAgICAgICAgICAgIHJlc3BvbnNlUGFyYW1ldGVyczoge1xuICAgICAgICAgICAgICAgICAgICAnbWV0aG9kLnJlc3BvbnNlLmhlYWRlci5BY2Nlc3MtQ29udHJvbC1BbGxvdy1IZWFkZXJzJzogXCInQ29udGVudC1UeXBlLFgtQW16LURhdGUsQXV0aG9yaXphdGlvbixYLUFwaS1LZXksWC1BbXotU2VjdXJpdHktVG9rZW4sQXV0aFRva2VuJ1wiLFxuICAgICAgICAgICAgICAgICAgICAnbWV0aG9kLnJlc3BvbnNlLmhlYWRlci5BY2Nlc3MtQ29udHJvbC1BbGxvdy1NZXRob2RzJzogXCInT1BUSU9OUyxHRVQsUFVULFBPU1QsREVMRVRFJ1wiLFxuICAgICAgICAgICAgICAgICAgICAnbWV0aG9kLnJlc3BvbnNlLmhlYWRlci5BY2Nlc3MtQ29udHJvbC1BbGxvdy1DcmVkZW50aWFscyc6IFwiJ2ZhbHNlJ1wiLFxuICAgICAgICAgICAgICAgICAgICAnbWV0aG9kLnJlc3BvbnNlLmhlYWRlci5BY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nOiBcIicqJ1wiLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9XSxcbiAgICAgICAgICAgIHBhc3N0aHJvdWdoQmVoYXZpb3I6IGFwaWcuUGFzc3Rocm91Z2hCZWhhdmlvci5ORVZFUixcbiAgICAgICAgICAgIHJlcXVlc3RUZW1wbGF0ZXM6IHtcbiAgICAgICAgICAgICAgICBcImFwcGxpY2F0aW9uL2pzb25cIjogXCJ7XFxcInN0YXR1c0NvZGVcXFwiOiAyMDB9XCJcbiAgICAgICAgICAgIH0sXG4gICAgICAgIH0pLCB7XG4gICAgICAgICAgICBtZXRob2RSZXNwb25zZXM6IFt7XG4gICAgICAgICAgICAgICAgc3RhdHVzQ29kZTogJzIwMCcsXG4gICAgICAgICAgICAgICAgcmVzcG9uc2VQYXJhbWV0ZXJzOiB7XG4gICAgICAgICAgICAgICAgICAgICdtZXRob2QucmVzcG9uc2UuaGVhZGVyLkFjY2Vzcy1Db250cm9sLUFsbG93LUhlYWRlcnMnOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICAnbWV0aG9kLnJlc3BvbnNlLmhlYWRlci5BY2Nlc3MtQ29udHJvbC1BbGxvdy1NZXRob2RzJzogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgJ21ldGhvZC5yZXNwb25zZS5oZWFkZXIuQWNjZXNzLUNvbnRyb2wtQWxsb3ctQ3JlZGVudGlhbHMnOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICAnbWV0aG9kLnJlc3BvbnNlLmhlYWRlci5BY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nOiB0cnVlLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9XVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBHZXRBUElHYXRld2F5QXJuKCkge1xuICAgICAgICAvLyByZXR1cm4gYGFybjphd3M6ZXhlY3V0ZS1hcGk6JHt0aGlzLmVudi5yZWdpb259OiR7dGhpcy5lbnYuYWNjb3VudH06JHt0aGlzLnJlc3RBcGlJZH0vZGV2YFxuICAgICAgICByZXR1cm4gYGFybjphd3M6YXBpZ2F0ZXdheToke3RoaXMuZW52LnJlZ2lvbn06Oi9yZXN0YXBpcy8ke3RoaXMucmVzdEFwaUlkfS9zdGFnZXMvJHt0aGlzLnN0YWdlTmFtZX1gXG4gICAgfVxuICAgIEFkZENvZ25pdG9BdXRob3JpemVyKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIFVzZXJQb29sczogY29nbml0by5Vc2VyUG9vbFtdKSB7XG4gICAgICAgIGNvbnN0IGF1dGggPSBuZXcgYXBpZy5Db2duaXRvVXNlclBvb2xzQXV0aG9yaXplcihzY29wZSwgaWQsIHtcbiAgICAgICAgICAgIGNvZ25pdG9Vc2VyUG9vbHM6IFVzZXJQb29sc1xuICAgICAgICB9KVxuICAgICAgICByZXR1cm4gYXV0aDtcbiAgICB9XG4gICAgQWRkQVBJR0F1dGhvcml6ZXIoc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgYXV0aEZuOiBsYW1iZGEuRnVuY3Rpb24pIHtcbiAgICAgICAgY29uc3QgYXV0aCA9IG5ldyBhcGlnLlJlcXVlc3RBdXRob3JpemVyKHNjb3BlLCBpZCwge1xuICAgICAgICAgICAgaGFuZGxlcjogYXV0aEZuLFxuICAgICAgICAgICAgaWRlbnRpdHlTb3VyY2VzOiBbYXBpZy5JZGVudGl0eVNvdXJjZS5oZWFkZXIoJ0F1dGhvcml6YXRpb24nKV1cbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBhdXRoO1xuICAgIH1cbiAgICBBZGRSZXNvdXJjZShGdWxsUGF0aDogc3RyaW5nKSB7XG4gICAgICAgIC8vQ2hlY2sgaWYgdGhlcmUgaXMgYWxyZWFkeSBhIHJlc291cmNlLlxuICAgICAgICBpZiAodGhpcy5rbm93blJlc291cmNlc1tGdWxsUGF0aF0gIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMua25vd25SZXNvdXJjZXNbRnVsbFBhdGhdO1xuICAgICAgICB9XG4gICAgICAgIC8vU3BsaXQgdXAgdGhlIHBhdGguXG4gICAgICAgIC8vY2hlY2sgaWYgdGhlIGJhc2UgcmVzb3VyY2VzIGFscmVhZHkgZXhpc3QsIGFuZCB0aGVuIHJldHVybiB0aGUgbGFzdCBvbmUuXG4gICAgICAgIGNvbnN0IHJvb3RQYXRoID0gdGhpcy5yb290O1xuICAgICAgICBjb25zdCBwYXJ0cyA9IEZ1bGxQYXRoLnNwbGl0KFwiL1wiKTtcbiAgICAgICAgbGV0IGN1cnJlbnRSZXNvdXJjZSA9IHRoaXMua25vd25SZXNvdXJjZXNbcGFydHNbMF1dO1xuICAgICAgICBpZiAodGhpcy5rbm93blJlc291cmNlc1twYXJ0c1swXV0gIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgY3VycmVudFJlc291cmNlID0gdGhpcy5rbm93blJlc291cmNlc1twYXJ0c1swXV07XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICBjdXJyZW50UmVzb3VyY2UgPSByb290UGF0aC5hZGRSZXNvdXJjZShwYXJ0c1swXSk7XG4gICAgICAgICAgICB0aGlzLmtub3duUmVzb3VyY2VzW3BhcnRzWzBdXSA9IGN1cnJlbnRSZXNvdXJjZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAocGFydHMubGVuZ3RoID4gMSkge1xuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPCBwYXJ0cy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIGxldCBjdXJyZW50UGF0aCA9IHBhcnRzLnNsaWNlKDAsIGkpLmpvaW4oXCIvXCIpO1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGN1cnJlbnRQYXRoKTtcbiAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICBjdXJyZW50UmVzb3VyY2UgPSBjdXJyZW50UmVzb3VyY2UuYWRkUmVzb3VyY2UocGFydHNbaV0pO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmtub3duUmVzb3VyY2VzW2N1cnJlbnRQYXRoXSA9IGN1cnJlbnRSZXNvdXJjZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgY2F0Y2gge1xuICAgICAgICAgICAgICAgICAgICBjdXJyZW50UmVzb3VyY2UgPSB0aGlzLmtub3duUmVzb3VyY2VzW2N1cnJlbnRQYXRoXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5hZGRDb3JzT3B0aW9ucyhjdXJyZW50UmVzb3VyY2UpO1xuICAgICAgICByZXR1cm4gY3VycmVudFJlc291cmNlO1xuICAgIH1cblxuICAgIEFkZE1ldGhvZEludGVncmF0aW9uKGludGVncmF0aW9uOiBhcGlnLkF3c0ludGVncmF0aW9uLCByb3V0ZTogc3RyaW5nID0gXCJcIiwgbWV0aG9kU3RyaW5nOiBzdHJpbmcsIGF1dGg6IGFwaWcuQXV0aG9yaXplcikge1xuICAgICAgICBjb25zdCByZXNvdXJjZSA9IHRoaXMuQWRkUmVzb3VyY2Uocm91dGUpO1xuICAgICAgICBjb25zdCBtZXRob2QgPSByZXNvdXJjZS5hZGRNZXRob2QoXG4gICAgICAgICAgICBtZXRob2RTdHJpbmcsXG4gICAgICAgICAgICBpbnRlZ3JhdGlvbixcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBhdXRob3JpemVyOiBhdXRoLFxuICAgICAgICAgICAgICAgIGF1dGhvcml6YXRpb25UeXBlOiBhdXRoLmF1dGhvcml6YXRpb25UeXBlXG4gICAgICAgICAgICB9KVxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gICAgQXR0YWNoV2ViQUNMKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcpIHtcbiAgICAgICAgY29uc3Qgd2ViQUNMID0gdGhpcy5HZXRXZWJBQ0woc2NvcGUsIGlkKTtcbiAgICAgICAgcmV0dXJuIG5ldyBjZGsuYXdzX3dhZnYyLkNmbldlYkFDTEFzc29jaWF0aW9uKFxuICAgICAgICAgICAgdGhpcyxcbiAgICAgICAgICAgIHRoaXMuaWQgKyAnX0NES1dlYkFDTEFzc29jJyxcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICB3ZWJBY2xBcm46IHdlYkFDTC5hdHRyQXJuLFxuICAgICAgICAgICAgICAgIHJlc291cmNlQXJuOiB0aGlzLkdldEFQSUdhdGV3YXlBcm4oKVxuICAgICAgICAgICAgfVxuICAgICAgICApO1xuICAgIH1cbiAgICBHZXRXZWJBQ0woc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZykge1xuICAgICAgICBjb25zdCB3YWZXZWJBQ0wgPSBuZXcgY2RrLmF3c193YWZ2Mi5DZm5XZWJBQ0woc2NvcGUsIGlkICsgXCJfV2ViQUNMXCIsXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgZGVzY3JpcHRpb246IFwiQmFzaWNXQUZcIixcbiAgICAgICAgICAgICAgICBkZWZhdWx0QWN0aW9uOiB7XG4gICAgICAgICAgICAgICAgICAgIGFsbG93OiB7fSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHNjb3BlOiBcIlJFR0lPTkFMXCIsXG4gICAgICAgICAgICAgICAgdmlzaWJpbGl0eUNvbmZpZzoge1xuICAgICAgICAgICAgICAgICAgICBjbG91ZFdhdGNoTWV0cmljc0VuYWJsZWQ6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgIG1ldHJpY05hbWU6IFwiV0FGQUNMR0xPQkFMXCIsXG4gICAgICAgICAgICAgICAgICAgIHNhbXBsZWRSZXF1ZXN0c0VuYWJsZWQ6IHRydWVcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHdhZldlYkFDTFxuICAgIH1cbiAgICBFeHBvcnRDb25maWcoKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBBUEk6IHtcbiAgICAgICAgICAgICAgICBlbmRwb2ludHM6IFtcbiAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogdGhpcy5yZXN0QXBpTmFtZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGVuZHBvaW50OiB0aGlzLmFwaUdhdGV3YXlVUkwsXG4gICAgICAgICAgICAgICAgICAgICAgICByZWdpb246IHRoaXMuZW52LnJlZ2lvblxuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIF0sXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG59XG4iXX0=