"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.restGateway = exports.restGatewayNestedStack = void 0;
const cdk = require("aws-cdk-lib");
const apig = require("aws-cdk-lib/aws-apigateway");
const helpers = require("./helperScripts");
class restGatewayNestedStack extends cdk.NestedStack {
    constructor(scope, id, description, stageName) {
        super(scope, id);
        this.gateway = new restGateway(scope, id + "_G", description, stageName);
    }
}
exports.restGatewayNestedStack = restGatewayNestedStack;
class restGateway extends apig.RestApi {
    constructor(scope, id, description, stageName = "dev") {
        const props = {
            description: description ? description : 'API Gateway Construct',
            deployOptions: {
                stageName: stageName ? stageName : 'dev',
            },
            defaultCorsPreflightOptions: {
                allowHeaders: [
                    'X-Amz-Date',
                    'Origin',
                    'Content-Type', 'X-Amz-Date', 'Authorization', 'X-Api-Key', 'X-Amz-Security-Token'
                ],
                allowMethods: ['OPTIONS', 'GET', 'POST'],
                allowCredentials: true,
                allowOrigins: ['*'],
            },
        };
        super(scope, id, props);
        this.knownResources = {};
        this.scope = scope;
        this.id = id;
        this.apiGatewayURL = this.url;
        this.stageName = stageName;
        helpers.OutputVariable(scope, 'API Rest URL', this.url, "Restful API Gateway URL");
    }
    GetAPIGatewayArn() {
        // return `arn:aws:execute-api:${this.env.region}:${this.env.account}:${this.restApiId}/dev`
        return `arn:aws:apigateway:${this.env.region}::/restapis/${this.restApiId}/stages/${this.stageName}`;
    }
    AddCognitoAuthorizer(scope, id, UserPools) {
        const auth = new apig.CognitoUserPoolsAuthorizer(scope, id, {
            cognitoUserPools: UserPools
        });
        return auth;
    }
    AddAPIGAuthorizer(scope, id, authFn) {
        const auth = new apig.RequestAuthorizer(scope, id, {
            handler: authFn,
            identitySources: [apig.IdentitySource.header('Authorization')]
        });
        return auth;
    }
    AddResource(FullPath) {
        //Check if there is already a resource.
        if (this.knownResources[FullPath] !== undefined) {
            return this.knownResources[FullPath];
        }
        //Split up the path.
        //check if the base resources already exist, and then return the last one.
        const rootPath = this.root;
        const parts = FullPath.split("/");
        let currentResource = this.knownResources[parts[0]];
        if (this.knownResources[parts[0]] !== undefined) {
            currentResource = this.knownResources[parts[0]];
        }
        else {
            currentResource = rootPath.addResource(parts[0]);
            this.knownResources[parts[0]] = currentResource;
        }
        if (parts.length > 1) {
            for (let i = 1; i < parts.length; i++) {
                let currentPath = parts.slice(0, i).join("/");
                console.log(currentPath);
                try {
                    currentResource = currentResource.addResource(parts[i]);
                    this.knownResources[currentPath] = currentResource;
                }
                catch {
                    currentResource = this.knownResources[currentPath];
                }
            }
        }
        return currentResource;
    }
    AddMethodIntegration(integration, route = "", methodString, auth) {
        const resource = this.AddResource(route);
        const method = resource.addMethod(methodString, integration, {
            authorizer: auth,
            authorizationType: auth.authorizationType
        });
        return true;
    }
    AttachWebACL(scope, id) {
        const webACL = this.GetWebACL(scope, id);
        return new cdk.aws_wafv2.CfnWebACLAssociation(this, this.id + '_CDKWebACLAssoc', {
            webAclArn: webACL.attrArn,
            resourceArn: this.GetAPIGatewayArn()
        });
    }
    GetWebACL(scope, id) {
        const wafWebACL = new cdk.aws_wafv2.CfnWebACL(scope, id + "_WebACL", {
            description: "BasicWAF",
            defaultAction: {
                allow: {},
            },
            scope: "REGIONAL",
            visibilityConfig: {
                cloudWatchMetricsEnabled: true,
                metricName: "WAFACLGLOBAL",
                sampledRequestsEnabled: true
            }
        });
        return wafWebACL;
    }
    ExportConfig() {
        return {
            API: {
                endpoints: [
                    {
                        name: this.restApiName,
                        endpoint: this.apiGatewayURL,
                        region: this.env.region
                    },
                ],
            }
        };
    }
}
exports.restGateway = restGateway;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBpZ2F0ZXdheS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImFwaWdhdGV3YXkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsbUNBQW1DO0FBQ25DLG1EQUFtRDtBQUduRCwyQ0FBMkM7QUFHM0MsTUFBYSxzQkFBdUIsU0FBUSxHQUFHLENBQUMsV0FBVztJQUV2RCxZQUFZLEtBQWdCLEVBQUUsRUFBVSxFQUFFLFdBQW9CLEVBQUUsU0FBa0I7UUFDOUUsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQTtRQUNoQixJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksV0FBVyxDQUFDLEtBQUssRUFBRSxFQUFFLEdBQUcsSUFBSSxFQUFFLFdBQVcsRUFBRSxTQUFTLENBQUMsQ0FBQTtJQUM1RSxDQUFDO0NBQ0o7QUFORCx3REFNQztBQUNELE1BQWEsV0FBWSxTQUFRLElBQUksQ0FBQyxPQUFPO0lBT3pDLFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsV0FBb0IsRUFBRSxZQUFvQixLQUFLO1FBQ3JGLE1BQU0sS0FBSyxHQUNYO1lBQ0ksV0FBVyxFQUFFLFdBQVcsQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyx1QkFBdUI7WUFDaEUsYUFBYSxFQUFFO2dCQUNYLFNBQVMsRUFBRSxTQUFTLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsS0FBSzthQUMzQztZQUNELDJCQUEyQixFQUFFO2dCQUN6QixZQUFZLEVBQUU7b0JBQ1YsWUFBWTtvQkFDWixRQUFRO29CQUNSLGNBQWMsRUFBRSxZQUFZLEVBQUUsZUFBZSxFQUFFLFdBQVcsRUFBRSxzQkFBc0I7aUJBQ3JGO2dCQUNELFlBQVksRUFBRSxDQUFDLFNBQVMsRUFBRSxLQUFLLEVBQUUsTUFBTSxDQUFDO2dCQUN4QyxnQkFBZ0IsRUFBRSxJQUFJO2dCQUN0QixZQUFZLEVBQUUsQ0FBQyxHQUFHLENBQUM7YUFDdEI7U0FDSixDQUFBO1FBQ0QsS0FBSyxD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LGFBQWEsRUFBRTtnQkFDWCxLQUFLLEVBQUUsRUFBRTthQUNaO1lBQ0QsS0FBSyxFQUFFLFVBQVU7WUFDakIsZ0JBQWdCLEVBQUU7Z0JBQ2Qsd0JBQXdCLEVBQUUsSUFBSTtnQkFDOUIsVUFBVSxFQUFFLGNBQWM7Z0JBQzFCLHNCQUFzQixFQUFFLElBQUk7YUFDL0I7U0FDSixDQUFDLENBQUM7UUFDUCxPQUFPLFNBQVMsQ0FBQTtJQUNwQixDQUFDO0lBQ0QsWUFBWTtRQUNSLE9BQU87WUFDSCxHQUFHLEVBQUU7Z0JBQ0QsU0FBUyxFQUFFO29CQUNQO3dCQUNJLElBQUksRUFBRSxJQUFJLENBQUMsV0FBVzt3QkFDdEIsUUFBUSxFQUFFLElBQUksQ0FBQyxhQUFhO3dCQUM1QixNQUFNLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNO3FCQUMxQjtpQkFDSjthQUNKO1NBQ0osQ0FBQTtJQUNMLENBQUM7Q0FDSjtBQXJJRCxrQ0FxSUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBjZGsgZnJvbSAnYXdzLWNkay1saWInO1xuaW1wb3J0ICogYXMgYXBpZyBmcm9tICdhd3MtY2RrLWxpYi9hd3MtYXBpZ2F0ZXdheSc7XG5pbXBvcnQgKiBhcyBjb2duaXRvIGZyb20gJ2F3cy1jZGstbGliL2F3cy1jb2duaXRvJztcbmltcG9ydCAqIGFzIGxhbWJkYSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtbGFtYmRhJztcbmltcG9ydCAqIGFzIGhlbHBlcnMgZnJvbSAnLi9oZWxwZXJTY3JpcHRzJztcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gJ2NvbnN0cnVjdHMnO1xuXG5leHBvcnQgY2xhc3MgcmVzdEdhdGV3YXlOZXN0ZWRTdGFjayBleHRlbmRzIGNkay5OZXN0ZWRTdGFjayB7XG4gICAgZ2F0ZXdheTogcmVzdEdhdGV3YXk7XG4gICAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgZGVzY3JpcHRpb24/OiBzdHJpbmcsIHN0YWdlTmFtZT86IHN0cmluZykge1xuICAgICAgICBzdXBlcihzY29wZSwgaWQpXG4gICAgICAgIHRoaXMuZ2F0ZXdheSA9IG5ldyByZXN0R2F0ZXdheShzY29wZSwgaWQgKyBcIl9HXCIsIGRlc2NyaXB0aW9uLCBzdGFnZU5hbWUpXG4gICAgfVxufVxuZXhwb3J0IGNsYXNzIHJlc3RHYXRld2F5IGV4dGVuZHMgYXBpZy5SZXN0QXBpIHtcbiAgICBzY29wZTogQ29uc3RydWN0O1xuICAgIGlkOiBTdHJpbmc7XG4gICAgYXBpR2F0ZXdheUFSTjogc3RyaW5nXG4gICAgYXBpR2F0ZXdheVVSTDogc3RyaW5nXG4gICAga25vd25SZXNvdXJjZXM6IHsgW2tleTogc3RyaW5nXTogYXBpZy5SZXNvdXJjZSB9ID0ge307XG4gICAgc3RhZ2VOYW1lOiBzdHJpbmdcbiAgICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBkZXNjcmlwdGlvbj86IHN0cmluZywgc3RhZ2VOYW1lOiBzdHJpbmcgPSBcImRldlwiKSB7XG4gICAgICAgIGNvbnN0IHByb3BzID1cbiAgICAgICAge1xuICAgICAgICAgICAgZGVzY3JpcHRpb246IGRlc2NyaXB0aW9uID8gZGVzY3JpcHRpb24gOiAnQVBJIEdhdGV3YXkgQ29uc3RydWN0JyxcbiAgICAgICAgICAgIGRlcGxveU9wdGlvbnM6IHtcbiAgICAgICAgICAgICAgICBzdGFnZU5hbWU6IHN0YWdlTmFtZSA/IHN0YWdlTmFtZSA6ICdkZXYnLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGRlZmF1bHRDb3JzUHJlZmxpZ2h0T3B0aW9uczoge1xuICAgICAgICAgICAgICAgIGFsbG93SGVhZGVyczogW1xuICAgICAgICAgICAgICAgICAgICAnWC1BbXotRGF0ZScsXG4gICAgICAgICAgICAgICAgICAgICdPcmlnaW4nLFxuICAgICAgICAgICAgICAgICAgICAnQ29udGVudC1UeXBlJywgJ1gtQW16LURhdGUnLCAnQXV0aG9yaXphdGlvbicsICdYLUFwaS1LZXknLCAnWC1BbXotU2VjdXJpdHktVG9rZW4nXG4gICAgICAgICAgICAgICAgXSxcbiAgICAgICAgICAgICAgICBhbGxvd01ldGhvZHM6IFsnT1BUSU9OUycsICdHRVQnLCAnUE9TVCddLFxuICAgICAgICAgICAgICAgIGFsbG93Q3JlZGVudGlhbHM6IHRydWUsXG4gICAgICAgICAgICAgICAgYWxsb3dPcmlnaW5zOiBbJyonXSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgIH1cbiAgICAgICAgc3VwZXIoc2NvcGUsIGlkLCBwcm9wcylcbiAgICAgICAgdGhpcy5zY29wZSA9IHNjb3BlO1xuICAgICAgICB0aGlzLmlkID0gaWQ7XG4gICAgICAgIHRoaXMuYXBpR2F0ZXdheVVSTCA9IHRoaXMudXJsO1xuICAgICAgICB0aGlzLnN0YWdlTmFtZSA9IHN0YWdlTmFtZTtcbiAgICAgICAgaGVscGVycy5PdXRwdXRWYXJpYWJsZShzY29wZSwgJ0FQSSBSZXN0IFVSTCcsIHRoaXMudXJsLCBcIlJlc3RmdWwgQVBJIEdhdGV3YXkgVVJMXCIpO1xuICAgIH1cbiAgICBHZXRBUElHYXRld2F5QXJuKCkge1xuICAgICAgICAvLyByZXR1cm4gYGFybjphd3M6ZXhlY3V0ZS1hcGk6JHt0aGlzLmVudi5yZWdpb259OiR7dGhpcy5lbnYuYWNjb3VudH06JHt0aGlzLnJlc3RBcGlJZH0vZGV2YFxuICAgICAgICByZXR1cm4gYGFybjphd3M6YXBpZ2F0ZXdheToke3RoaXMuZW52LnJlZ2lvbn06Oi9yZXN0YXBpcy8ke3RoaXMucmVzdEFwaUlkfS9zdGFnZXMvJHt0aGlzLnN0YWdlTmFtZX1gXG4gICAgfVxuICAgIEFkZENvZ25pdG9BdXRob3JpemVyKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIFVzZXJQb29sczogY29nbml0by5Vc2VyUG9vbFtdKSB7XG4gICAgICAgIGNvbnN0IGF1dGggPSBuZXcgYXBpZy5Db2duaXRvVXNlclBvb2xzQXV0aG9yaXplcihzY29wZSwgaWQsIHtcbiAgICAgICAgICAgIGNvZ25pdG9Vc2VyUG9vbHM6IFVzZXJQb29sc1xuICAgICAgICB9KVxuICAgICAgICByZXR1cm4gYXV0aDtcbiAgICB9XG4gICAgQWRkQVBJR0F1dGhvcml6ZXIoc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgYXV0aEZuOiBsYW1iZGEuRnVuY3Rpb24pIHtcbiAgICAgICAgY29uc3QgYXV0aCA9IG5ldyBhcGlnLlJlcXVlc3RBdXRob3JpemVyKHNjb3BlLCBpZCwge1xuICAgICAgICAgICAgaGFuZGxlcjogYXV0aEZuLFxuICAgICAgICAgICAgaWRlbnRpdHlTb3VyY2VzOiBbYXBpZy5JZGVudGl0eVNvdXJjZS5oZWFkZXIoJ0F1dGhvcml6YXRpb24nKV1cbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBhdXRoO1xuICAgIH1cbiAgICBBZGRSZXNvdXJjZShGdWxsUGF0aDogc3RyaW5nKSB7XG4gICAgICAgIC8vQ2hlY2sgaWYgdGhlcmUgaXMgYWxyZWFkeSBhIHJlc291cmNlLlxuICAgICAgICBpZiAodGhpcy5rbm93blJlc291cmNlc1tGdWxsUGF0aF0gIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMua25vd25SZXNvdXJjZXNbRnVsbFBhdGhdO1xuICAgICAgICB9XG4gICAgICAgIC8vU3BsaXQgdXAgdGhlIHBhdGguXG4gICAgICAgIC8vY2hlY2sgaWYgdGhlIGJhc2UgcmVzb3VyY2VzIGFscmVhZHkgZXhpc3QsIGFuZCB0aGVuIHJldHVybiB0aGUgbGFzdCBvbmUuXG4gICAgICAgIGNvbnN0IHJvb3RQYXRoID0gdGhpcy5yb290O1xuICAgICAgICBjb25zdCBwYXJ0cyA9IEZ1bGxQYXRoLnNwbGl0KFwiL1wiKTtcbiAgICAgICAgbGV0IGN1cnJlbnRSZXNvdXJjZSA9IHRoaXMua25vd25SZXNvdXJjZXNbcGFydHNbMF1dO1xuICAgICAgICBpZiAodGhpcy5rbm93blJlc291cmNlc1twYXJ0c1swXV0gIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgY3VycmVudFJlc291cmNlID0gdGhpcy5rbm93blJlc291cmNlc1twYXJ0c1swXV07XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICBjdXJyZW50UmVzb3VyY2UgPSByb290UGF0aC5hZGRSZXNvdXJjZShwYXJ0c1swXSk7XG4gICAgICAgICAgICB0aGlzLmtub3duUmVzb3VyY2VzW3BhcnRzWzBdXSA9IGN1cnJlbnRSZXNvdXJjZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAocGFydHMubGVuZ3RoID4gMSkge1xuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPCBwYXJ0cy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIGxldCBjdXJyZW50UGF0aCA9IHBhcnRzLnNsaWNlKDAsIGkpLmpvaW4oXCIvXCIpO1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGN1cnJlbnRQYXRoKTtcbiAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICBjdXJyZW50UmVzb3VyY2UgPSBjdXJyZW50UmVzb3VyY2UuYWRkUmVzb3VyY2UocGFydHNbaV0pO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmtub3duUmVzb3VyY2VzW2N1cnJlbnRQYXRoXSA9IGN1cnJlbnRSZXNvdXJjZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgY2F0Y2gge1xuICAgICAgICAgICAgICAgICAgICBjdXJyZW50UmVzb3VyY2UgPSB0aGlzLmtub3duUmVzb3VyY2VzW2N1cnJlbnRQYXRoXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGN1cnJlbnRSZXNvdXJjZTtcbiAgICB9XG5cbiAgICBBZGRNZXRob2RJbnRlZ3JhdGlvbihpbnRlZ3JhdGlvbjogYXBpZy5Bd3NJbnRlZ3JhdGlvbiwgcm91dGU6IHN0cmluZyA9IFwiXCIsIG1ldGhvZFN0cmluZzogc3RyaW5nLCBhdXRoOiBhcGlnLkF1dGhvcml6ZXIpIHtcbiAgICAgICAgY29uc3QgcmVzb3VyY2UgPSB0aGlzLkFkZFJlc291cmNlKHJvdXRlKTtcbiAgICAgICAgY29uc3QgbWV0aG9kID0gcmVzb3VyY2UuYWRkTWV0aG9kKFxuICAgICAgICAgICAgbWV0aG9kU3RyaW5nLFxuICAgICAgICAgICAgaW50ZWdyYXRpb24sXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgYXV0aG9yaXplcjogYXV0aCxcbiAgICAgICAgICAgICAgICBhdXRob3JpemF0aW9uVHlwZTogYXV0aC5hdXRob3JpemF0aW9uVHlwZVxuICAgICAgICAgICAgfSlcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIEF0dGFjaFdlYkFDTChzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nKSB7XG4gICAgICAgIGNvbnN0IHdlYkFDTCA9IHRoaXMuR2V0V2ViQUNMKHNjb3BlLCBpZCk7XG4gICAgICAgIHJldHVybiBuZXcgY2RrLmF3c193YWZ2Mi5DZm5XZWJBQ0xBc3NvY2lhdGlvbihcbiAgICAgICAgICAgIHRoaXMsXG4gICAgICAgICAgICB0aGlzLmlkICsgJ19DREtXZWJBQ0xBc3NvYycsXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgd2ViQWNsQXJuOiB3ZWJBQ0wuYXR0ckFybixcbiAgICAgICAgICAgICAgICByZXNvdXJjZUFybjogdGhpcy5HZXRBUElHYXRld2F5QXJuKClcbiAgICAgICAgICAgIH1cbiAgICAgICAgKTtcbiAgICB9XG4gICAgR2V0V2ViQUNMKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcpIHtcbiAgICAgICAgY29uc3Qgd2FmV2ViQUNMID0gbmV3IGNkay5hd3Nfd2FmdjIuQ2ZuV2ViQUNMKHNjb3BlLCBpZCArIFwiX1dlYkFDTFwiLFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiBcIkJhc2ljV0FGXCIsXG4gICAgICAgICAgICAgICAgZGVmYXVsdEFjdGlvbjoge1xuICAgICAgICAgICAgICAgICAgICBhbGxvdzoge30sXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBzY29wZTogXCJSRUdJT05BTFwiLFxuICAgICAgICAgICAgICAgIHZpc2liaWxpdHlDb25maWc6IHtcbiAgICAgICAgICAgICAgICAgICAgY2xvdWRXYXRjaE1ldHJpY3NFbmFibGVkOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICBtZXRyaWNOYW1lOiBcIldBRkFDTEdMT0JBTFwiLFxuICAgICAgICAgICAgICAgICAgICBzYW1wbGVkUmVxdWVzdHNFbmFibGVkOiB0cnVlXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiB3YWZXZWJBQ0xcbiAgICB9XG4gICAgRXhwb3J0Q29uZmlnKCkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgQVBJOiB7XG4gICAgICAgICAgICAgICAgZW5kcG9pbnRzOiBbXG4gICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IHRoaXMucmVzdEFwaU5hbWUsXG4gICAgICAgICAgICAgICAgICAgICAgICBlbmRwb2ludDogdGhpcy5hcGlHYXRld2F5VVJMLFxuICAgICAgICAgICAgICAgICAgICAgICAgcmVnaW9uOiB0aGlzLmVudi5yZWdpb25cbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBdLFxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxufVxuIl19